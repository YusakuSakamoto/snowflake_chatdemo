# ビュー設計：[[design.V_CUSTOMER_MASTER]]

## 概要
APP_PRODUCTION.[[design.V_CUSTOMER_MASTER]] は、取込テーブル（案件明細）から取引先（顧客）マスタ相当の情報を抽出し、参照・分析に適した形で提供する正規化 VIEW である。

取込テーブルは欠損・重複・表記揺れを許容する一次受け皿であり、取引先情報も複数行に分散して現れる。  
本 VIEW はそれらを取引先ID単位に集約し、下流（案件・請求・セマンティックモデル）で安定して JOIN できる入口を作る。

## 位置づけ（レイヤ）
- 入力：取込（Raw / Landing）層の案件明細テーブル（[[design.ANKEN_MEISAI]]）
- 出力：提供（Views / Normalized）層の取引先マスタ VIEW
- 下流利用：
  - セマンティックモデル（YAML）の CUSTOMERS テーブル相当
  - 案件マスタ（[[design.V_PROJECT_MASTER]]）等との JOIN
  - Analyst / Agent の検索・集計・フィルタ対象

本 VIEW は、外部の正本顧客マスタを置き換えるものではなく、デモ用途の正規化提供層として機能する。

## 粒度（Grain）
本 VIEW の 1レコードは 取引先ID単位を表す。

- 取引先ID

取込側では同一取引先IDが複数行（複数案件・複数明細）に現れるため、VIEW 側で 1取引先=1行 に集約する。

## 代表値の選択（`ANY_VALUE` の意図）
取引先名は取込側に複数回出現しうる。  
デモでは、同一取引先IDに対して取引先名が基本的に一致していることを期待するが、完全一致を保証しない。

そのため、本 VIEW では取引先名を代表値として1つ採用する。

- `ANY_VALUE` は「代表値を一つ取る」ための実装であり、同一ID内で名称が揺れている場合の正しさを保証しない
- 名称揺れが運用上の問題になる場合は、別途データ品質チェック（監査 VIEW / テスト）で検知することが望ましい

## 有効無効（`ACTIVE_FLAG`）の扱い
取込側では同一取引先IDに対して複数の active_flag が現れる可能性がある。  
本 VIEW は参照用途のため、下流でフィルタに利用できるよう 集約された状態の active_flag を提供する。

- 集約方針は「代表値」ではなく「状態の統合」を意図する
- デモでは MAX 等の集約で単一値にまとめることがあるが、値体系（Y/N、0/1、文字列大小等）に依存するため、厳密な意味は後段（正本化）で定義する

本 VIEW は「取込データから参照可能な状態を作る」ことを目的とし、有効無効の業務判定を確定させる層ではない。

## フィルタ方針（NULL除外）
取引先ID が NULL の行は取引先マスタとして扱えないため、本 VIEW では除外する。

- 取引先IDが存在するデータのみを「マスタ相当」として提供する
- 取引先IDが欠損している明細行は、取込層に保持されていること自体に意味がある（＝本 VIEW の責務外）

## データ品質に関する前提
本 VIEW は、取込層のデータ品質を完全に保証するものではない。  
ただし、参照・分析で最低限破綻しないために以下を前提とする。

- 取引先IDが NULL の行は除外される
- 同一取引先ID内で名称・フラグが揺れている場合、集約結果が採用される（揺れは別途検知対象）

## 運用上の注意
- 本 VIEW は参照・分析の入口として利用し、取込テーブル（[[design.ANKEN_MEISAI]]）を直接参照する運用を避ける
- 取引先名や active_flag の揺れが重要な場合、監査用のチェック（例：同一IDで複数名称が存在する件数）を追加する
- 将来的に正本顧客マスタが導入される場合、本 VIEW は「暫定の正規化入口」として位置づけを見直す

## 関連
- スキーマ設計：[[design.APP_PRODUCTION]]
- 取込テーブル設計：[[design.ANKEN_MEISAI]]
- 関連 VIEW：[[design.V_PROJECT_MASTER]] / [[design.V_ORDER_MASTER]] / [[design.V_INVOICE]]
- セマンティックモデル（CUSTOMERS）：YAML 側の CUSTOMERS 定義（別途管理）

---
