# ビュー設計：V_INVOICE

## 概要
APP_PRODUCTION.V_INVOICE は、取込テーブル（案件明細）から **請求（invoice）を分析・参照しやすい単位に整形**して提供する VIEW である。

取込側では請求番号が欠損している行や、同一請求が複数明細に分割されているケースがあり得る。  
本 VIEW はその前提を受け入れた上で、以下を実現する。

- 請求の粒度を「請求×計上月」に固定する
- 請求番号が無い場合でも、請求を表すキーを作って集計可能にする
- 金額を請求単位で集計し、参照・分析の入口を提供する

## 位置づけ（レイヤ）
- 入力：取込（Raw / Landing）層の案件明細テーブル（ANKEN_MEISAI）
- 出力：提供（Views / Normalized）層の請求 VIEW
- 下流利用：
  - セマンティックモデル（YAML）の INVOICES テーブル相当
  - オーダ（V_ORDER_MASTER）との JOIN 起点
  - 月次売上（請求金額）集計のベース

本 VIEW は請求の正本テーブルではなく、デモ用途の「正規化提供層」として機能する。

## 粒度（Grain）
本 VIEW の 1レコードは、以下の単位を表す。

- 請求キー（invoice_key）
- 計上月（accounting_month）

請求番号が存在する場合は請求番号が実質的な識別子になる。  
一方で、請求番号が欠損しているケースを許容するため、本 VIEW では「請求キー」を導入して粒度を安定させる。

## 請求キー（invoice_key）の設計意図
取込データには、請求番号（invoice_number）が欠損している明細が存在しうる。  
その場合でも「請求という概念」を分析上扱えるよう、本 VIEW では請求キーを定義する。

- 請求番号がある場合：請求番号をキーとして採用する
- 請求番号がない場合：オーダ番号を用いて仮キーを生成する  
  （例：NO_INVOICE_<order_number>）

この設計により、
- 請求番号が無い明細を WHERE 句で除外せずに済む
- 売上集計（請求金額）の欠落を避けられる
- 「請求番号の欠損」をデータ品質問題として可視化しつつ、分析は継続できる

※ 仮キーは「請求の正本識別子」ではなく、「集計・参照のための暫定キー」である。

## 集計の考え方（SUM / MAX / ANY_VALUE）
取込側では同一請求（キー）・同一計上月に複数明細が存在しうるため、本 VIEW は請求単位に集約する。

- 金額は請求の合計値として SUM する（請求金額の集計済値を提供する）
- 売上渡しフラグ等の状態は、同一請求内で矛盾していても VIEW を破綻させないために集約する  
  （例：MAX による代表状態の選択）
- オーダ番号など請求に紐づく参照キーは、同一請求内で基本的に一致する前提で代表値として選択し得る

本 VIEW はデータ品質の矛盾を解決する層ではなく、
「分析で扱える最小限の形にまとめる層」である。

## フィルタ方針（重要）
本 VIEW は、請求番号が無い行を **除外しない**。  
請求番号欠損を理由にデータを落とすと、売上集計が欠落するためである。

したがって、
- 請求番号が無い明細は仮キー側に集約される
- 欠損の存在は結果（invoice_key の形）で可視化される

## 計上月（accounting_month）の意味
本 VIEW の粒度は「請求×計上月」であり、計上月は請求集計の基準となる。

- 取込層では計上月が文字列表現であることを許容する
- セマンティックモデル側では、計上月を DATE（当月1日）に変換して時系列分析に利用することがある  
  （VIEW 自体は「保持」と「集約」を主目的とする）

## データ品質に関する前提
本 VIEW は、取込層のデータ品質を完全に保証するものではない。  
ただし、参照・分析で最低限破綻しないよう、以下を前提とする。

- 請求番号欠損は許容し、仮キーで集約する
- 同一請求内で属性が揺れている場合、集約結果が採用される（揺れは別途検知対象）
- 計上月が欠損または不正な場合、請求単位の集計結果に影響しうる（監査対象）

## 運用上の注意
- 本 VIEW は売上（請求金額）集計の入口として利用し、取込テーブルを直接参照する運用を避ける
- 仮キー（NO_INVOICE_*）が発生する割合は、データ品質の重要指標になり得る
- 将来的に請求正本テーブルや請求番号管理が導入される場合、本 VIEW の仮キー設計は見直し対象となる

## 関連
- スキーマ設計：[[design.APP_PRODUCTION]]
- 取込テーブル設計：[[design.ANKEN_MEISAI]]
- 関連 VIEW：[[design.V_ORDER_MASTER]] / [[design.V_PROJECT_MASTER]] / [[design.V_CUSTOMER_MASTER]]
- セマンティックモデル（INVOICES）：YAML 側の INVOICES 定義（別途管理）

---
