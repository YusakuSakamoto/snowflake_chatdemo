# ビュー設計：V_ORDER_MASTER

## 概要
APP_PRODUCTION.V_ORDER_MASTER は、取込テーブル（案件明細）から **オーダ（受注）単位の情報**を抽出し、参照・分析に適した形で提供する正規化 VIEW である。

取込層では、同一オーダ番号に対して複数の案件・明細行が存在しうる。  
本 VIEW はその前提を受け入れつつ、**オーダ番号単位に粒度を固定**し、下流で安定して JOIN・集計できる入口を提供する。

## 位置づけ（レイヤ）
- 入力：取込（Raw / Landing）層の案件明細テーブル（ANKEN_MEISAI）
- 出力：提供（Views / Normalized）層のオーダマスタ VIEW
- 下流利用：
  - セマンティックモデル（YAML）の ORDERS テーブル相当
  - 案件マスタ（V_PROJECT_MASTER）との JOIN
  - 請求 VIEW（V_INVOICE）との JOIN 起点

本 VIEW は、業務システムにおける正本オーダマスタを置き換えるものではなく、  
デモ用途の「正規化された参照入口」として機能する。

## 粒度（Grain）
本 VIEW の 1レコードは **オーダ番号単位**を表す。

- オーダ番号

取込側では、同一オーダ番号が複数案件・複数年度に跨って現れる可能性があるが、  
本 VIEW では「オーダ番号を軸とした代表的な情報」を 1行に集約する。

## カラムの考え方（意味付け）
本 VIEW では、オーダを識別・参照するための最小限の属性を提供する。

- オーダの識別（オーダ番号）
- オーダ名称
- オーダに紐づく案件情報（案件番号・枝番・年度）
- 顧客注文番号など、オーダを補足する参照情報

オーダに直接関係しない明細粒度の情報（請求・金額等）は、本 VIEW には含めない。

## 代表値の選択（ANY_VALUE の意図）
取込側では、同一オーダ番号に対して以下が複数行に分散して現れうる。

- オーダ名
- 案件番号・枝番・年度
- 顧客注文番号

デモの前提では、同一オーダ番号に対するこれらの属性が基本的に一致していることを期待しつつ、  
一致しない場合でも VIEW を破綻させないため、代表値取得として ANY_VALUE を利用する。

- ANY_VALUE は「代表値を1つ取る」ための実装であり、正しさを保証しない
- 属性の揺れが業務上問題になる場合は、別途データ品質チェックで検知・対処する

## フィルタ方針（NULL除外）
オーダ番号が NULL の行は、オーダマスタとして扱えないため、本 VIEW では除外する。

- オーダ番号が存在するデータのみをオーダ単位の情報として提供する
- オーダ番号欠損の明細行は、取込層に保持されていること自体に意味がある（＝本 VIEW の責務外）

## データ品質に関する前提
本 VIEW は、取込層のデータ品質を完全に保証するものではない。  
ただし、参照・分析で最低限破綻しないために以下を前提とする。

- オーダ番号が NULL の行は除外される
- 同一オーダ番号内で属性が揺れている場合、代表値が採用される（揺れは別途検知対象）

## 運用上の注意
- 本 VIEW は参照・分析の入口として利用し、取込テーブル（ANKEN_MEISAI）を直接参照する運用を避ける
- JOIN はオーダ番号をキーとして行う前提とする
- 将来的に正本オーダマスタが導入される場合、本 VIEW は「暫定的な正規化入口」として位置づけを見直す

## 関連
- スキーマ設計：[[design.APP_PRODUCTION]]
- 取込テーブル設計：[[design.ANKEN_MEISAI]]
- 関連 VIEW：[[design.V_PROJECT_MASTER]] / [[design.V_INVOICE]] / [[design.V_CUSTOMER_MASTER]]
- セマンティックモデル（ORDERS）：YAML 側の ORDERS 定義（別途管理）

---
