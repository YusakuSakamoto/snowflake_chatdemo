# ビュー設計：[[design.V_PROJECT_MASTER]]

## 概要
APP_PRODUCTION.V_PROJECT_MASTER は、取込テーブル（案件明細）から案件マスタ相当の情報を抽出し、参照・分析に適した粒度で提供するための正規化 VIEW である。

取込テーブルは「来たものを保持する層」であり、欠損・重複・形式揺れを許容する。  
本 VIEW はその入力を前提に、分析で扱いやすいよう粒度の固定と代表値の選択、および日付の型変換を行う。

## 位置づけ（レイヤ）
- 入力：取込（Raw / Landing）層の案件明細テーブル（[[design.ANKEN_MEISAI]]）
- 出力：提供（Views / Normalized）層の案件マスタ VIEW
- 下流利用：
  - セマンティックモデル（YAML）の PROJECTS テーブル相当
  - 他 VIEW（ORDERS / INVOICES 等）との JOIN 起点
  - Analyst / Agent からの参照

本 VIEW は「案件の正本テーブル」を置き換えるものではなく、デモ用途の正規化提供層として機能する。

## 粒度（Grain）
本 VIEW の 1レコードは、以下のキーで一意に表現される案件単位を表す。

- 案件番号
- 枝番
- 年度

この粒度は、デモで「案件」を識別するための最小単位として採用する。  
取込側で同一案件が複数行（明細行）として存在することを前提に、VIEW 側で 1案件=1行 に集約する。

## カラムの考え方（意味付け）
本 VIEW では、案件を表現するための属性を提供する。

- 案件の識別（案件番号・枝番・年度）
- 案件の名称・説明（案件名・件名 等）
- 案件の分類（売上区分・ランク 等）
- 案件に紐づく参照キー（取引先ID、部署ID 等）
- 期間情報（作業開始日・作業終了日）

取込層に存在する冗長なラベル（部署名・略称等）は、案件マスタとしての必須属性ではないため、本 VIEW の主目的から外れる場合は含めない。

## 代表値の選択（`ANY_VALUE` の意図）
取込側では、同一案件キー（案件番号・枝番・年度）に対して複数行が存在しうる。  
その場合、本 VIEW は案件単位に集約するため、名称や分類などの属性について 代表値を選択する必要がある。

デモの前提では、取込データ内で同一案件キーに対する属性値が基本的に一致していることを期待しつつ、  
一致しない場合でも VIEW を破綻させないために、代表値取得として `ANY_VALUE` を利用する。

- `ANY_VALUE` は「代表値を一つ取る」ための実装であり、同一キー内で値が揺れている場合の正しさを保証しない
- 値の揺れが発生しうる場合は、別途データ品質チェック（監査 VIEW / テスト）で検知することが望ましい

## 日付の型変換（`TRY_TO_DATE` の意図）
取込層では日付・期間が文字列として格納されることがある。  
本 VIEW では分析・フィルタ・期間計算の利便性を高めるため、作業開始日・終了日について 日付型への変換を行う。

- 取込文字列が不正フォーマットの場合でも VIEW をエラーにしないため、`TRY_TO_DATE` を用いる
- 変換に失敗した場合は NULL になり得る（＝入力データ不備を表す）

「取込で止めない」思想を維持しつつ、「参照で扱いやすくする」ための変換である。

## データ品質に関する前提
本 VIEW は、取込層のデータ品質を完全に保証するものではない。  
ただし、参照・分析で最低限破綻しないために以下を前提とする。

- 案件番号が NULL の行は案件マスタとして扱えないため除外される
- 同一案件キー内で属性が揺れている場合、代表値が採用される（揺れは別途検知対象）

## 運用上の注意
- 本 VIEW は参照・分析の入口として利用し、取込テーブル（[[design.ANKEN_MEISAI]]）を直接参照する運用を避ける
- 本 VIEW のキー（案件番号・枝番・年度）は、下流 JOIN の基準となるため、セマンティックモデルでも同じ粒度を採用する
- データ品質要件が上がる場合は、`ANY_VALUE` 前提から「正本テーブル化（制約・検証）」へ段階的に移行する

## 関連
- スキーマ設計：[[design.APP_PRODUCTION]]
- 取込テーブル設計：[[design.ANKEN_MEISAI]]
- セマンティックモデル（PROJECTS）：YAML 側の PROJECTS 定義（別途管理）
- 関連 VIEW：[[design.V_ORDER_MASTER]] / [[design.V_CUSTOMER_MASTER]] / [[design.V_INVOICE]]

---
