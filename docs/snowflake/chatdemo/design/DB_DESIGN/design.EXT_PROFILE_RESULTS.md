# 外部テーブル設計：[[design.EXT_PROFILE_RESULTS]]

## 概要
[[DB_DESIGN.EXT_PROFILE_RESULTS]] は、データベーステーブルの各カラムに対して算出されたプロファイル計測結果をS3上のJSONLファイルとして保持し、Snowflakeから外部テーブルとして直接参照するテーブルである。  
1行が「1回のプロファイル実行（run）」における「1カラム分の計測結果」を表し、  
[[DB_DESIGN.PROFILE_RUNS.RUN_ID]] を起点として、対象テーブル・対象カラム・計測時点・計測結果を紐づける。

本テーブルは、プロファイル処理の結果を外部ストレージに永続化し、品質確認・比較・監査・設計レビューの根拠として利用される。内部テーブル版（[[design.PROFILE_RESULTS]]）と同一の論理構造を持ちながら、S3直接参照によるストレージコスト最適化と長期保存を実現する。

## 業務上の意味
- このテーブルが表す概念  
  - 「プロファイル結果（column-level metrics）」の外部永続化蓄積。
  - 1行は、ある run における、ある 1カラムの計測結果を表す。
  - 計測対象は  
    [[DB_DESIGN.PROFILE_RESULTS.TARGET_DB]] / [[DB_DESIGN.PROFILE_RESULTS.TARGET_SCHEMA]] / [[DB_DESIGN.PROFILE_RESULTS.TARGET_TABLE]] / [[DB_DESIGN.PROFILE_RESULTS.TARGET_COLUMN]]  
    により特定される。
- 主な利用シーン  
  - 長期データ品質トレンド分析（過去数ヶ月〜数年の比較）
  - 監査・コンプライアンス対応における証跡データとしての参照
  - コスト効率を重視した大量プロファイル結果の保存
  - 定期的な品質レポート生成の基礎データ

## 設計上の位置づけ

### 内部テーブル版との関係
本外部テーブルは [[DB_DESIGN.PROFILE_RESULTS]] と論理的に同一構造を持つ。

- 論理設計の共通性  
  - カラム構成、データ型、主キーの考え方は内部テーブル版と同一とする。
  - [[DB_DESIGN.PROFILE_RESULTS.RUN_ID]] と [[DB_DESIGN.PROFILE_RESULTS.TARGET_COLUMN]] の複合キーにより、1run・1カラムあたり1行を前提とする。
  - METRICS 構造は VARIANT 型であり、将来拡張を許容する。

- 物理配置の違い  
  - 内部テーブル：Snowflake管理ストレージに格納、高速検索・集計に最適化
  - 外部テーブル：S3直接参照、ストレージコスト最適化・長期保存に適する

### 使い分けの方針
- 内部テーブル（[[design.PROFILE_RESULTS]]）を使うべきケース  
  - 頻繁なクエリ実行（日次監視、リアルタイム分析）
  - 複雑な JOIN や集計が必要な分析処理
  - 低レイテンシが要求される運用監視
  
- 外部テーブル（[[design.EXT_PROFILE_RESULTS]]）を使うべきケース  
  - 長期保存が主目的（過去1年以上のデータ）
  - 参照頻度が低い履歴データの保管
  - ストレージコストの削減が優先される状況
  - 外部システムとのデータ共有（S3経由）

## 設計方針

### S3統合設計
- ステージ名：[[design.OBSIDIAN_VAULT_STAGE]]  
  S3バケット `s3://snowflake-chatdemo-vault-prod/` への外部ステージを前提とする。

- ファイルフォーマット：FF_JSON_LINES  
  1行1JSONのJSON Lines形式（NDJSON）を採用し、ストリーミング書き込みと部分読み取りの効率化を図る。

- S3パス構造：  
  ```
  s3://snowflake-chatdemo-vault-prod/profile_results/year=YYYY/month=MM/day=DD/
  ```
  - プロファイル実行日時（STARTED_AT または書き込み日時）を基準としたパーティション構造とする。
  - 年月日によるパーティショニングにより、クエリ時のスキャン範囲を限定し、検索効率を向上させる。

### パーティショニング戦略
- パーティションキー：year / month / day  
  実行日時に基づく時系列パーティションを採用する。

- 設計理由  
  - プロファイル結果の参照は「特定期間のデータ品質変化」を追跡するケースが多い。
  - 日次パーティションにより、必要な期間のデータのみをスキャン対象とすることで、クエリコストを削減できる。
  - S3上のファイル配置とSnowflakeのパーティションプルーニングが連動し、不要なファイル読み取りを回避する。

- パーティション粒度の考慮  
  - 日次（day）パーティションは、典型的なプロファイル実行頻度（日次バッチ）と整合する。
  - 月次パーティションでは粒度が粗すぎ、時間単位パーティションでは細かすぎる可能性がある。
  - 実運用データ量が増加した場合、時間単位への細分化を検討する余地がある。

### 自動リフレッシュ
- auto_refresh: false  
  手動またはスケジュールによるリフレッシュを前提とし、自動リフレッシュは無効化する。

- 設計理由  
  - プロファイル結果は日次バッチ等で定期的に書き込まれることを想定する。
  - 自動リフレッシュは予期しないコスト増加を招く可能性があるため、明示的な制御を優先する。
  - 必要に応じて `ALTER EXTERNAL TABLE ... REFRESH` を実行する運用とする。

## コスト vs 性能のトレードオフ

### ストレージコスト
- 外部テーブル（S3）：低コスト  
  S3ストレージ単価はSnowflake管理ストレージより大幅に安価である。
  長期保存が必要なプロファイル履歴データにおいて、外部テーブル化によるコスト削減効果は大きい。

- 内部テーブル：高コスト  
  Snowflake管理ストレージは高可用性・高性能を提供する反面、単価が高い。
  数年分の履歴データを内部テーブルに保持すると、ストレージコストが増大する。

### クエリ性能
- 外部テーブル：低速〜中速  
  - S3からのファイル読み取りはネットワーク経由となり、レイテンシが発生する。
  - パーティションプルーニングが効果的に働く場合、性能劣化は限定的である。
  - 複雑なJOINや集計処理では、内部テーブルに比べて性能が劣る可能性がある。

- 内部テーブル：高速  
  - Snowflake管理ストレージは最適化されており、低レイテンシでのアクセスが可能。
  - マイクロパーティション・クラスタリングにより、高速な検索・集計が実現される。

### 運用の考え方
- 初期段階では内部テーブル（[[design.PROFILE_RESULTS]]）にデータを蓄積し、定期的に外部テーブル（[[design.EXT_PROFILE_RESULTS]]）へアーカイブする運用を推奨する。
- 直近数ヶ月のデータは内部テーブルで高速参照を実現し、過去データは外部テーブルでコスト効率的に保存する。
- 必要に応じて、内部テーブルと外部テーブルを統合するビュー（UNION ALL）を定義し、アプリケーションからは統一的にアクセスできるようにする。

## 運用上の注意点

### データ書き込み
- 外部テーブルへの直接 INSERT / UPDATE / DELETE は不可である。
- S3へのデータ書き込みは、以下のいずれかの方法で行う。
  - COPY INTO コマンドによる内部テーブルから外部ステージへのエクスポート
  - 外部プロセス（Azure Functions、AWS Lambda等）によるS3直接書き込み
  - Snowpipe による継続的なファイル取り込み（リアルタイム要件がある場合）

### メタデータリフレッシュ
- 新規ファイルがS3に追加された場合、外部テーブルのメタデータをリフレッシュする必要がある。
  ```sql
  ALTER EXTERNAL TABLE DB_DESIGN.EXT_PROFILE_RESULTS REFRESH;
  ```
- リフレッシュは定期的なスケジュール実行（Task）または手動実行により行う。

### パーティション管理
- パーティションフォルダ（year=YYYY/month=MM/day=DD/）の命名規則を厳守する。
- 誤ったパーティション構造でファイルを配置すると、クエリ時のパーティションプルーニングが機能せず、性能劣化やコスト増加を招く。

### データ品質担保
- 外部テーブルは Snowflake の制約（PRIMARY KEY、FOREIGN KEY、CHECK）を持たない。
- データ品質は書き込み側のプロセス（プロシージャ、外部アプリケーション）で担保する必要がある。
- 不正なデータがS3に書き込まれた場合、外部テーブルからの参照時にエラーやNULL値として扱われる可能性がある。

## 将来拡張の余地
- パーティション粒度の最適化（時間単位への細分化、または週次・月次への集約）
- 圧縮形式の見直し（Parquet、ORC等への変更によるストレージ効率向上）
- 内部テーブルとの自動同期機構（Task + Stream による定期アーカイブ）
- 外部テーブル用マテリアライズドビューの検討（頻繁な集計クエリの高速化）
- S3ライフサイクルポリシーとの連携（古いパーティションのGlacier移行）

## 関連

- 内部テーブル版：[[DB_DESIGN.PROFILE_RESULTS]]
- 関連外部テーブル：[[DB_DESIGN.EXT_PROFILE_RUNS]]
- 関連プロシージャ：[[DB_DESIGN.PROFILE_TABLE]], [[DB_DESIGN.PROFILE_ALL_TABLES]]
- マスター定義：[[DB_DESIGN.EXT_PROFILE_RESULTS]]（master/externaltables/）
