# 外部テーブル設計：[[design.PROFILE_RUNS_EXTERNAL]]

## 概要
[[DB_DESIGN.PROFILE_RUNS_EXTERNAL]] は、データベーステーブルに対して実行したプロファイル処理（例：行数、列統計、欠損率などの算出）の実行履歴をS3上のJSONLファイルとして保持し、Snowflakeから外部テーブルとして直接参照するテーブルである。  
1行が1回のプロファイル実行（= run）を表し、対象テーブル・実行条件・実行時間・実行状態を記録することで、監視・再実行・トラブルシュート・結果テーブルとの紐付けに利用する。

本テーブルは、プロファイル実行履歴を外部ストレージに永続化し、長期的なトレーサビリティ確保とストレージコスト最適化を実現する。内部テーブル版（[[design.PROFILE_RUNS]]）と同一の論理構造を持ちながら、S3直接参照による長期保存とコスト削減を両立する。

## 業務上の意味
- このテーブルが表す概念  
  - 「プロファイル実行ジョブ（run）」の外部永続化台帳（ジョブ管理・履歴管理）。
  - runは「いつ」「どの対象（DB / Schema / Table）に」「どんな条件（サンプル率、Warehouse、Role、コードバージョン）」で実行されたか、
    および「結果が成功／失敗／実行中のどれか」を表す。
  - 各runは `RUN_ID` により識別され、結果テーブル（[[design.PROFILE_RESULTS_EXTERNAL]]）と論理的に関連付けられる。
  
- 主な利用シーン  
  - 長期的なプロファイル実行履歴の監査・トレーサビリティ確保
  - 過去数ヶ月〜数年の実行傾向分析（成功率、実行時間の推移）
  - コスト効率を重視した大量実行履歴の保存
  - 障害対応時の過去実行履歴の調査（低頻度アクセス）

## 設計上の位置づけ

### 内部テーブル版との関係
本外部テーブルは [[DB_DESIGN.PROFILE_RUNS]] と論理的に同一構造を持つ。

- 論理設計の共通性  
  - カラム構成、データ型、主キーの考え方は内部テーブル版と同一とする。
  - RUN_ID により1回の実行を一意に識別する。
  - STATUS（RUNNING / SUCCEEDED / FAILED）による状態管理を前提とする。

- 物理配置の違い  
  - 内部テーブル：Snowflake管理ストレージに格納、高速検索・運用監視に最適化
  - 外部テーブル：S3直接参照、ストレージコスト最適化・長期保存に適する

### 使い分けの方針
- 内部テーブル（[[design.PROFILE_RUNS]]）を使うべきケース  
  - 日次運用監視（最新の実行状態確認、失敗runの即時検知）
  - 頻繁なクエリ実行（直近数週間〜数ヶ月の履歴参照）
  - 低レイテンシが要求される運用監視ダッシュボード

- 外部テーブル（[[design.PROFILE_RUNS_EXTERNAL]]）を使うべきケース  
  - 長期保存が主目的（過去1年以上の実行履歴）
  - 監査・コンプライアンス対応における証跡データとしての参照
  - 参照頻度が低い履歴データの保管
  - ストレージコストの削減が優先される状況

### 結果テーブルとの関係
[[DB_DESIGN.PROFILE_RESULTS_EXTERNAL]] は本テーブルに紐づく結果詳細を保持する。

- 関係性  
  [[design.PROFILE_RUNS_EXTERNAL]]（1） → [[design.PROFILE_RESULTS_EXTERNAL]]（N）
- 関連キー  
  PROFILE_RESULTS_EXTERNAL.RUN_ID → PROFILE_RUNS_EXTERNAL.RUN_ID

外部テーブル間でのJOINも可能だが、性能面では内部テーブル版のJOINに劣る可能性がある。

## 設計方針

### S3統合設計
- ステージ名：[[design.OBSIDIAN_VAULT_STAGE]]  
  S3バケット `s3://snowflake-chatdemo-vault-prod/` への外部ステージを前提とする。

- ファイルフォーマット：FF_JSON_LINES  
  1行1JSONのJSON Lines形式（NDJSON）を採用し、ストリーミング書き込みと部分読み取りの効率化を図る。

- S3パス構造：  
  ```
  s3://snowflake-chatdemo-vault-prod/profile_runs/year=YYYY/month=MM/day=DD/
  ```
  - プロファイル実行開始日時（STARTED_AT）を基準としたパーティション構造とする。
  - 年月日によるパーティショニングにより、クエリ時のスキャン範囲を限定し、検索効率を向上させる。

### パーティショニング戦略
- パーティションキー：year / month / day  
  実行開始日時（STARTED_AT）に基づく時系列パーティションを採用する。

- 設計理由  
  - プロファイル実行履歴の参照は「特定期間の実行状況」を確認するケースが多い。
  - 日次パーティションにより、必要な期間のデータのみをスキャン対象とすることで、クエリコストを削減できる。
  - S3上のファイル配置とSnowflakeのパーティションプルーニングが連動し、不要なファイル読み取りを回避する。

- パーティション粒度の考慮  
  - 日次（day）パーティションは、典型的なプロファイル実行頻度（日次バッチ）と整合する。
  - 実行頻度が高い場合（時間単位での頻繁な実行）、時間単位パーティションへの細分化を検討する。
  - 逆に実行頻度が低い場合（週次・月次）、月次パーティションへの集約を検討する。

### 自動リフレッシュ
- auto_refresh: false  
  手動またはスケジュールによるリフレッシュを前提とし、自動リフレッシュは無効化する。

- 設計理由  
  - プロファイル実行履歴は日次バッチ等で定期的に書き込まれることを想定する。
  - 自動リフレッシュは予期しないコスト増加を招く可能性があるため、明示的な制御を優先する。
  - 必要に応じて `ALTER EXTERNAL TABLE ... REFRESH` を実行する運用とする。

## コスト vs 性能のトレードオフ

### ストレージコスト
- 外部テーブル（S3）：低コスト  
  S3ストレージ単価はSnowflake管理ストレージより大幅に安価である。
  長期保存が必要なプロファイル実行履歴において、外部テーブル化によるコスト削減効果は大きい。

- 内部テーブル：高コスト  
  Snowflake管理ストレージは高可用性・高性能を提供する反面、単価が高い。
  数年分の実行履歴を内部テーブルに保持すると、ストレージコストが増大する。

### クエリ性能
- 外部テーブル：低速〜中速  
  - S3からのファイル読み取りはネットワーク経由となり、レイテンシが発生する。
  - パーティションプルーニングが効果的に働く場合、性能劣化は限定的である。
  - [[design.PROFILE_RESULTS_EXTERNAL]] との JOIN は、両方とも外部テーブルの場合、性能が劣化する可能性がある。

- 内部テーブル：高速  
  - Snowflake管理ストレージは最適化されており、低レイテンシでのアクセスが可能。
  - マイクロパーティション・クラスタリングにより、高速な検索・集計が実現される。
  - [[design.PROFILE_RESULTS]] との JOIN も高速に実行される。

### 運用の考え方
- 初期段階では内部テーブル（[[design.PROFILE_RUNS]]）にデータを蓄積し、定期的に外部テーブル（[[design.PROFILE_RUNS_EXTERNAL]]）へアーカイブする運用を推奨する。
- 直近数ヶ月の実行履歴は内部テーブルで高速参照を実現し、過去データは外部テーブルでコスト効率的に保存する。
- 必要に応じて、内部テーブルと外部テーブルを統合するビュー（UNION ALL）を定義し、アプリケーションからは統一的にアクセスできるようにする。

## 運用上の注意点

### データ書き込み
- 外部テーブルへの直接 INSERT / UPDATE / DELETE は不可である。
- S3へのデータ書き込みは、以下のいずれかの方法で行う。
  - COPY INTO コマンドによる内部テーブルから外部ステージへのエクスポート
  - 外部プロセス（Azure Functions、AWS Lambda等）によるS3直接書き込み
  - Snowpipe による継続的なファイル取り込み（リアルタイム要件がある場合）

### メタデータリフレッシュ
- 新規ファイルがS3に追加された場合、外部テーブルのメタデータをリフレッシュする必要がある。
  ```sql
  ALTER EXTERNAL TABLE DB_DESIGN.PROFILE_RUNS_EXTERNAL REFRESH;
  ```
- リフレッシュは定期的なスケジュール実行（Task）または手動実行により行う。

### パーティション管理
- パーティションフォルダ（year=YYYY/month=MM/day=DD/）の命名規則を厳守する。
- 誤ったパーティション構造でファイルを配置すると、クエリ時のパーティションプルーニングが機能せず、性能劣化やコスト増加を招く。
- `STARTED_AT` の日時とパーティションフォルダの日付が一致することを確認する。

### データ品質担保
- 外部テーブルは Snowflake の制約（PRIMARY KEY、CHECK）を持たない。
- データ品質は書き込み側のプロセス（プロシージャ、外部アプリケーション）で担保する必要がある。
- 状態遷移の整合性（RUNNING → SUCCEEDED / FAILED）や時刻の整合性（`STARTED_AT` ≦ `FINISHED_AT`）は書き込み側で保証する。

### 実行中ステータスの扱い
- STATUS='RUNNING' のrunは、実行中または異常終了により完了していない可能性がある。
- 外部テーブルへのアーカイブ時には、完了状態（SUCCEEDED / FAILED）のrunのみを対象とすることを推奨する。
- 実行中runは内部テーブルで管理し、完了後に外部テーブルへエクスポートする運用が望ましい。

## 将来拡張の余地
- パーティション粒度の最適化（時間単位への細分化、または週次・月次への集約）
- 圧縮形式の見直し（Parquet、ORC等への変更によるストレージ効率向上）
- 内部テーブルとの自動同期機構（Task + Stream による定期アーカイブ）
- 外部テーブル用マテリアライズドビューの検討（頻繁な集計クエリの高速化）
- S3ライフサイクルポリシーとの連携（古いパーティションのGlacier移行）
- 実行失敗時のエラー情報詳細化（`ERROR_CODE`、ERROR_MESSAGE の構造化）

## 関連

- 内部テーブル版：[[DB_DESIGN.PROFILE_RUNS]]
- 関連外部テーブル：[[DB_DESIGN.PROFILE_RESULTS_EXTERNAL]]
- 関連プロシージャ：[[DB_DESIGN.PROFILE_TABLE]], [[DB_DESIGN.PROFILE_ALL_TABLES]]
- マスター定義：[[DB_DESIGN.PROFILE_RUNS_EXTERNAL]]（master/externaltables/）
