# LOG.AZSWA_LOGS 設計ドキュメント  
（Azure Static Web Apps アクセスログ／外部テーブル）

---

## 0. 本ドキュメントの位置づけ

本ファイルは [[LOG.AZSWA_LOGS]] テーブルの 設計意図・判断・運用前提 を記載する。  
DDL 定義の正本は master 配下にあり、本ドキュメントは以下を目的とする。

- なぜそのカラムが存在するか
- なぜその型・nullable・粒度なのか
- Snowflake（EXTERNAL TABLE）前提で、どのように品質を担保するか
- レビュー指摘への対応履歴と設計判断の確定

---

## 1. テーブル概要

### 1.1 目的

[[LOG.AZSWA_LOGS]] は、Azure Static Web Apps（Next.js フロントエンド）の  
HTTPリクエスト単位のアクセスログを集約・分析するための外部テーブルである。

- ログは S3 上に JSON 形式で保存される
- Snowflake から EXTERNAL TABLE として直接参照する
- 長期的な行動分析・エラー監視・UX改善を主目的とする

### 1.2 レコード粒度

- 1レコード = 1 HTTP リクエスト
- フロントエンドで処理されたリクエストの結果を表す

---

## 2. 設計上の前提（EXTERNAL TABLE）

### 2.1 制約に関する基本方針

Snowflake の EXTERNAL TABLE では以下を前提とする。

- PRIMARY KEY / UNIQUE / FOREIGN KEY  
  - 宣言可能だが 強制（enforced）されない
  - DDLレベルの品質担保には使わない
- CHECK 制約  
  - Snowflakeでは未サポート
  - DDLに記載しない

よって、本テーブルの品質担保は以下で行う。

- 設計ドキュメントでの明示
- 検証クエリ
- 取り込み元（アプリ／ETL）での制御
- 必要に応じた内部テーブル化

---

## 3. 主キー・識別子設計

### 3.1 log_id（主キー相当）

- 意味: HTTPリクエストを一意に識別するID
- 生成方法: リクエスト処理時に UUID を生成
- 設計判断:
  - EXTERNAL TABLE では PK を強制できないため、  
    「一意であるべき識別子」として設計意図を明示する
  - 重複検知は検証クエリ・下流処理で行う

---

## 4. STATUS / STATUS_CODE 設計（High-1対応確定）

### 4.1 設計背景

HTTPログにおいて「状態」を1つのカラムで表すと、  
HTTPプロトコルの状態と アプリケーション内部状態が混在し、  
分析・集計・アラート設計が不明瞭になる。

そのため、本テーブルでは意図的に2つを分離する。

---

### 4.2 各カラムの役割

#### STATUS_CODE（NUMBER）

- 意味: HTTPプロトコル標準の応答コード
- 例: 200 / 301 / 404 / 500
- 利用目的:
  - HTTPレイヤの可視化
  - エラー率（4xx / 5xx）監視
  - アラート・SLO計測
- 主分析指標: HTTP観点ではこちらを主とする

#### STATUS（VARCHAR, nullable）

- 意味: アプリケーション／業務ロジックの状態
- 想定値:
  - RUNNING
  - SUCCEEDED
  - FAILED
- 利用目的:
  - 内部処理フローの状態把握
  - 業務レベルの異常検知
- 主分析指標: アプリ／業務観点ではこちらを主とする

---

### 4.3 設計上の注意

- STATUS_CODE と STATUS は 粒度・責務が異なる
- HTTPの集計・可視化・アラートは STATUS_CODE を用いる
- 業務ロジックの状態分析は STATUS を用いる
- どちらかが恒常的に不要になった場合は、  
  設計段階で削除を検討する

---

## 5. 時系列・パーティション設計

### 5.1 時刻カラム

#### timestamp（TIMESTAMP_NTZ）

- 意味: リクエストを受信した日時（UTC）
- 利用:
  - 時系列分析
  - 日次・時間帯別集計

---

### 5.2 パーティションカラム

#### year / month / day / hour

- 役割: S3 パス分割およびパーティションプルーニング用
- 形式:
  - year: NUMBER(4,0)
  - month/day/hour: NUMBER(2,0)
- 注意:
  - NOT NULL を設計上明示するが、EXTERNAL TABLE では強制されない
  - NULL 混入はパフォーマンス劣化・コスト増加に直結する

---

### 5.3 品質担保（運用）

- 定期的に NULL 混入検証を行う
- 異常時は S3 側データを修正・除外する

---

## 6. セッション・ユーザー関連カラム

### 6.1 session_id（VARCHAR, nullable）

- 意味: ユーザーセッション識別子
- 取得元: Cookie / ローカルストレージ
- 利用目的:
  - セッション単位の行動分析
- 設計判断:
  - 匿名・初回アクセスでは NULL を許容

---

### 6.2 user_agent（VARCHAR, nullable）

- 意味: ブラウザ／デバイス情報
- 利用:
  - デバイス別利用傾向分析

---

## 7. パフォーマンス・エラー関連

### 7.1 response_time_ms（NUMBER, nullable）

- 意味: レスポンスタイム（ミリ秒）
- NULL理由:
  - 測定不能
  - エラーによる途中終了
- 利用:
  - P95 / P99 レイテンシ分析

---

## 8. セキュリティ・プライバシー

### 8.1 client_ip（VARCHAR, nullable）

- 意味: クライアントIPアドレス
- 方針:
  - 個人特定を避けるため、最後のオクテットをマスク
- 利用:
  - 地域別傾向
  - 異常アクセス検知

---

### 8.2 metadata（VARIANT）

- 意味: 拡張コンテキスト情報
- 想定内容:
  - referrer
  - A/Bテスト識別子
  - 実験フラグ
- 設計判断:
  - 可変項目の吸収用
  - 濫用を防ぐため、主要分析軸は固定カラムで持つ

---

## 9. データ整合性（論理参照）

### 9.1 request_id

- Azure SWA が自動付与する識別子
- [[LOG.AZFUNCTIONS_LOGS]] 等との論理的 JOIN に利用
- FK 制約は設定せず、検証クエリで整合性を担保

---

## 10. 運用・監視設計（要点）

- AUTO_REFRESH 失敗回数
- 新規ファイル増加量
- スキャン量・クレジット消費
- 404 / 5xx の急増検知

※ 実装は別途運用ドキュメントに記載する。

---

## 11. 将来拡張方針

- 高頻度集計は内部テーブル・MV化を検討
- 長期ログは S3 ライフサイクルでコスト最適化
- 分析用途拡張時も、本設計思想を維持する

---

## 12. レビュー対応履歴

- 2026-01-03  
  - STATUS / STATUS_CODE の役割分担を明文化（High-1対応）
  - 外部テーブル制約・品質担保方針を明確化
  - 設計と実装DDLの責務分離を整理

---
