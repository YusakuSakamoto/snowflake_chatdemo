# スキーマ設計：APP_PRODUCTION

## 概要
APP_PRODUCTION スキーマは、デモ用途の「らくらく案件データ」を Snowflake 上で扱うための最小構成スキーマである。  
外部（主に CSV）から取り込んだデータを受け止める取込テーブル層と、取込データを元に整形・正規化して提供する VIEW 層を分離し、Analyst（セマンティックモデル）や Agent（Cortex Agent）から利用できる状態を作る。

本スキーマにおける基本思想は以下：
- 取込の安定性を最優先（取込テーブルでは制約を強くしない）
- 参照・分析は VIEW を正本とする（生テーブル直参照を避ける）
- デモ手順（COPY / VIEW / YAML / Analyst / Agent）を再現可能な形で保持する

## スキーマ内のレイヤ構成

### 1) 取込（Raw / Landing）層
CSV をそのまま受け止める一次受け皿。  
形式揺れ、欠損、重複があってもロードを止めない設計判断を許容する。

- 例：
  - ANKEN_MEISAI（案件明細：CSV取込用）
  - DEPARTMENT_MASTER（部署マスタ（年度別）：CSV取込用）
- 取込層では以下を「意図的に行わない」ことがある：
  - 主キー / 外部キー制約
  - NOT NULL 制約
  - 厳密な型制約（日付・コードの統一など）
- データ品質保証は後段（VIEW / 正規化層）の責務とする。

### 2) 提供（Views / Normalized）層
取込層のデータを、参照・分析に適した粒度・型・意味に整形して提供する層。  
デモでは「正規化 VIEW 群」として実装し、Analyst のセマンティックモデルの入力として利用する。

- 例：
  - V_CUSTOMER_MASTER（案件明細から生成する取引先マスタVIEW）
  - V_PROJECT_MASTER（案件番号＋枝番＋年度単位の案件マスタVIEW）
  - V_ORDER_MASTER（オーダ番号単位のオーダマスタVIEW）
  - V_INVOICE（請求番号×計上月単位、金額集計済のVIEW）
  - V_PROJECT_FACT（生データ粒度を保持するファクトVIEW）

提供層は、取込層の内容を「直接更新」せず、参照用途のための投影・整形のみを行う。

### 3) セマンティックモデル（YAML）層
提供層（VIEW 群）を元に、Analyst（cortex_analyst_text_to_sql）向けに  
ディメンション／ファクト／メトリクス／リレーションシップを定義する層。

- 目的：
  - 自然言語→SQL 変換を安定させる
  - 用語揺れ（同義語）を吸収する
  - JOIN の関係性を明示して誤結合を減らす
- 重要：
  - セマンティックモデルは「参照・分析の入口」であり、取込層を直接対象にしない運用を基本とする。

### 4) Agent / API 連携層（デモ）
デモでは、Cortex Agent を Azure Functions から呼び出し、SWA（静的Web）でチャットUIを提供する。

- Agent はスキーマ内データを検索・参照する設定（デモ用途）
- 実行ロール・ネットワークポリシー（PAT）等を用いて API 実行を制御する

## 主要コンポーネントの関係（概念図）
CSV / 外部ファイル
  → （STAGE: RAW_DATA）
  → （COPY INTO）
  → 取込テーブル（ANKEN_MEISAI / DEPARTMENT_MASTER）
  → 提供 VIEW（V_*）
  → セマンティックモデル（YAML）
  → Analyst / Agent
  → Azure Functions API
  → SWA UI

## 設計方針

### 取込テーブルを「正本」にしない
取込テーブルは「来たものを保持する層」であり、
- 欠損や重複があり得る
- 表現揺れ（文字列日付、コード揺れ）があり得る
ことを前提とする。

そのため、参照・集計・検索は原則として VIEW 層を経由する。

### VIEW 層で意味を確定させる
VIEW 層では、以下のような「意味の確定」を行う。
- 粒度の定義（案件・オーダ・請求など）
- 型変換（例：文字列日付 → DATE への変換）
- 集計や仮キーの補完（請求番号なしの場合のキー付与等）

ただし VIEW は「更新」ではなく「提供」であるため、取込層の原データは保持される。

### キー設計の考え方（デモ前提）
デモでは、業務上の完全な参照整合や制約実装よりも、
- 分析で必要な JOIN が成立すること
- 粒度がぶれないこと
- 欠損があっても破綻しないこと
を優先する。

そのため、自然キー（例：案件番号＋枝番＋年度）や仮キー（請求番号なしの請求キー）を VIEW 側で組み立てることがある。

## 運用上の注意
- 取込テーブルへの直接参照を前提に BI / アプリケーションを構築しない
- 参照先は VIEW（正規化 VIEW 群）を基本とする
- COPY 実行は ON_ERROR=CONTINUE 等により「止めない」運用を許容する（デモ前提）
- セマンティックモデルは VIEW を入力として設計し、同義語・JOIN 関係を明示する

## 将来拡張の余地
- 取込管理の高度化（取込実行ID、エラーログ、ハッシュ等の付与）
- VIEW 層からテーブル（正本）層への昇格（SCD、有効期間、整合性制約の導入）
- スキーマ内の命名規約・レイヤ規約の明文化（RAW / V_ / MART 等）

## 関連
- テーブル設計：[[design.ANKEN_MEISAI]]
- テーブル設計：[[design.DEPARTMENT_MASTER]]
- デモ手順書：本ノート作成時点の手順書（Snowflake設定 / Azure Functions / SWA）

---



schema_id:: SCH_20251225131727

```dataview
TABLE comment, physical
FROM "master/tables"
WHERE schema_id = this.schema_id
SORT schema_id, physical
```
