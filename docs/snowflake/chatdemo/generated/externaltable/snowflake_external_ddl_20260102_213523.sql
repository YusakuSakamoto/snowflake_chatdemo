-- ==============================
-- EXTERNAL TABLES
-- ==============================

-- SKIP: DB_DESIGN.EXT_PROFILE_RESULTS (no columns)

CREATE OR REPLACE EXTERNAL TABLE DB_DESIGN.EXT_PROFILE_RUNS(
  STATUS VARCHAR AS (value:status::VARCHAR)
)PARTITION BY (YEAR, MONTH, DAY)
LOCATION=@DB_DESIGN.OBSIDIAN_VAULT_STAGE/profile_runs/
FILE_FORMAT=(TYPE=JSON)
AUTO_REFRESH=FALSE
REFRESH_ON_CREATE=TRUE;

COMMENT ON TABLE DB_DESIGN.EXT_PROFILE_RUNS IS 'プロファイル実行管理テーブル（S3直接参照）。1行が1回のプロファイル実行を表し、実行履歴・トレーサビリティ確保に利用される。';
COMMENT ON COLUMN DB_DESIGN.EXT_PROFILE_RUNS.STATUS IS 'プロファイル実行の状態。許可値は以下の通り：RUNNING : 実行中SUCCEEDED : 正常終了FAILED : 異常終了状態遷移は原則として RUNNING → SUCCEEDED | FAILED のみとする。 (外部テーブル版: EXT_PROFILE_RUNS)';

CREATE OR REPLACE EXTERNAL TABLE LOG.AZFUNCTIONS_LOGS(
  DURATION_MS NUMBER AS (value:duration_ms::NUMBER),
  EXCEPTION VARIANT AS (value:exception::VARIANT),
  FUNCTION_NAME VARCHAR AS (value:function_name::VARCHAR),
  INVOCATION_ID VARCHAR AS (value:invocation_id::VARCHAR),
  LEVEL VARCHAR AS (value:level::VARCHAR),
  LOG_ID VARCHAR AS (value:log_id::VARCHAR),
  MESSAGE VARCHAR AS (value:message::VARCHAR),
  METADATA VARIANT AS (value:metadata::VARIANT),
  STATUS_CODE NUMBER AS (value:status_code::NUMBER),
  TIMESTAMP TIMESTAMP_NTZ AS (value:timestamp::TIMESTAMP_NTZ),
  DAY NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 4), '=', 2) AS NUMBER),
  HOUR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 5), '=', 2) AS NUMBER),
  MONTH NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 3), '=', 2) AS NUMBER),
  YEAR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 2), '=', 2) AS NUMBER)
)PARTITION BY (YEAR, MONTH, DAY, HOUR)
LOCATION=@LOG.LOGS_STAGE/azfunctions/
FILE_FORMAT=(TYPE=JSON)
AUTO_REFRESH=TRUE
REFRESH_ON_CREATE=TRUE;

COMMENT ON TABLE LOG.AZFUNCTIONS_LOGS IS 'Azure Functionsログ（外部テーブル）';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.DAY IS 'パーティション:日';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.DURATION_MS IS '実行時間(ミリ秒)';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.EXCEPTION IS '例外情報';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.FUNCTION_NAME IS '関数名';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.HOUR IS 'パーティション:時';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.INVOCATION_ID IS '実行ID';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.LEVEL IS 'ログレベル (INFO/WARNING/ERROR)';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.LOG_ID IS 'ログID';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.MESSAGE IS 'ログメッセージ';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.METADATA IS 'メタデータ';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.MONTH IS 'パーティション:月';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.STATUS_CODE IS 'HTTPステータスコード';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.TIMESTAMP IS 'タイムスタンプ';
COMMENT ON COLUMN LOG.AZFUNCTIONS_LOGS.YEAR IS 'パーティション:年';

CREATE OR REPLACE EXTERNAL TABLE LOG.AZSWA_LOGS(
  CLIENT_IP VARCHAR AS (value:client_ip::VARCHAR),
  LOG_ID VARCHAR AS (value:log_id::VARCHAR),
  METADATA VARIANT AS (value:metadata::VARIANT),
  METHOD VARCHAR AS (value:method::VARCHAR),
  REQUEST_ID VARCHAR AS (value:request_id::VARCHAR),
  RESPONSE_TIME_MS NUMBER AS (value:response_time_ms::NUMBER),
  SESSION_ID VARCHAR AS (value:session_id::VARCHAR),
  STATUS_CODE NUMBER AS (value:status_code::NUMBER),
  TIMESTAMP TIMESTAMP_NTZ AS (value:timestamp::TIMESTAMP_NTZ),
  URL VARCHAR AS (value:url::VARCHAR),
  USER_AGENT VARCHAR AS (value:user_agent::VARCHAR),
  DAY NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 4), '=', 2) AS NUMBER),
  HOUR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 5), '=', 2) AS NUMBER),
  MONTH NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 3), '=', 2) AS NUMBER),
  YEAR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 2), '=', 2) AS NUMBER)
)PARTITION BY (YEAR, MONTH, DAY, HOUR)
LOCATION=@LOG.LOGS_STAGE/azswa/
FILE_FORMAT=(TYPE=JSON)
AUTO_REFRESH=TRUE
REFRESH_ON_CREATE=TRUE;

COMMENT ON TABLE LOG.AZSWA_LOGS IS 'Azure Static Web Appsログ（外部テーブル）';
COMMENT ON COLUMN LOG.AZSWA_LOGS.CLIENT_IP IS 'クライアントIP';
COMMENT ON COLUMN LOG.AZSWA_LOGS.DAY IS 'パーティション:日';
COMMENT ON COLUMN LOG.AZSWA_LOGS.HOUR IS 'パーティション:時';
COMMENT ON COLUMN LOG.AZSWA_LOGS.LOG_ID IS 'ログID';
COMMENT ON COLUMN LOG.AZSWA_LOGS.METADATA IS 'メタデータ';
COMMENT ON COLUMN LOG.AZSWA_LOGS.METHOD IS 'HTTPメソッド';
COMMENT ON COLUMN LOG.AZSWA_LOGS.MONTH IS 'パーティション:月';
COMMENT ON COLUMN LOG.AZSWA_LOGS.REQUEST_ID IS 'リクエストID';
COMMENT ON COLUMN LOG.AZSWA_LOGS.RESPONSE_TIME_MS IS '応答時間(ミリ秒)';
COMMENT ON COLUMN LOG.AZSWA_LOGS.SESSION_ID IS 'セッションID';
COMMENT ON COLUMN LOG.AZSWA_LOGS.STATUS_CODE IS 'HTTPステータスコード';
COMMENT ON COLUMN LOG.AZSWA_LOGS.TIMESTAMP IS 'タイムスタンプ';
COMMENT ON COLUMN LOG.AZSWA_LOGS.URL IS 'リクエストURL';
COMMENT ON COLUMN LOG.AZSWA_LOGS.USER_AGENT IS 'ユーザーエージェント';
COMMENT ON COLUMN LOG.AZSWA_LOGS.YEAR IS 'パーティション:年';

CREATE OR REPLACE EXTERNAL TABLE LOG.CORTEX_CONVERSATIONS(
  AGENT_NAME VARCHAR AS (value:agent_name::VARCHAR),
  CONVERSATION_ID VARCHAR AS (value:conversation_id::VARCHAR),
  MESSAGE_CONTENT VARIANT AS (value:message_content::VARIANT),
  MESSAGE_ROLE VARCHAR AS (value:message_role::VARCHAR),
  METADATA VARIANT AS (value:metadata::VARIANT),
  SESSION_ID VARCHAR AS (value:session_id::VARCHAR),
  TIMESTAMP TIMESTAMP_NTZ AS (value:timestamp::TIMESTAMP_NTZ),
  USER_ID VARCHAR AS (value:user_id::VARCHAR),
  DAY NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 4), '=', 2) AS NUMBER),
  HOUR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 5), '=', 2) AS NUMBER),
  MONTH NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 3), '=', 2) AS NUMBER),
  YEAR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 2), '=', 2) AS NUMBER)
)PARTITION BY (YEAR, MONTH, DAY, HOUR)
LOCATION=@LOG.LOGS_STAGE/cortex_conversations/
FILE_FORMAT=(TYPE=JSON)
AUTO_REFRESH=TRUE
REFRESH_ON_CREATE=TRUE;

COMMENT ON TABLE LOG.CORTEX_CONVERSATIONS IS 'Cortex Agent会話ログ（外部テーブル）';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.AGENT_NAME IS 'エージェント名';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.CONVERSATION_ID IS '会話ID';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.DAY IS 'パーティション:日';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.HOUR IS 'パーティション:時';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.MESSAGE_CONTENT IS 'メッセージ内容';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.MESSAGE_ROLE IS 'メッセージロール (user/assistant)';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.METADATA IS 'メタデータ';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.MONTH IS 'パーティション:月';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.SESSION_ID IS 'セッションID';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.TIMESTAMP IS 'タイムスタンプ';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.USER_ID IS 'ユーザーID';
COMMENT ON COLUMN LOG.CORTEX_CONVERSATIONS.YEAR IS 'パーティション:年';

CREATE OR REPLACE EXTERNAL TABLE LOG.SNOWFLAKE_METRICS(
  METADATA VARIANT AS (value:metadata::VARIANT),
  METRIC_ID VARCHAR AS (value:metric_id::VARCHAR),
  METRIC_NAME VARCHAR AS (value:metric_name::VARCHAR),
  METRIC_VALUE NUMBER AS (value:metric_value::NUMBER),
  QUERY_ID VARCHAR AS (value:query_id::VARCHAR),
  TIMESTAMP TIMESTAMP_NTZ AS (value:timestamp::TIMESTAMP_NTZ),
  USER_NAME VARCHAR AS (value:user_name::VARCHAR),
  WAREHOUSE_NAME VARCHAR AS (value:warehouse_name::VARCHAR),
  DAY NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 4), '=', 2) AS NUMBER),
  HOUR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 5), '=', 2) AS NUMBER),
  MONTH NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 3), '=', 2) AS NUMBER),
  YEAR NUMBER AS CAST(SPLIT_PART(SPLIT_PART(metadata$filename, '/', 2), '=', 2) AS NUMBER)
)PARTITION BY (YEAR, MONTH, DAY, HOUR)
LOCATION=@LOG.LOGS_STAGE/snowflake_metrics/
FILE_FORMAT=(TYPE=JSON)
AUTO_REFRESH=TRUE
REFRESH_ON_CREATE=TRUE;

COMMENT ON TABLE LOG.SNOWFLAKE_METRICS IS 'Snowflakeメトリクスログ（外部テーブル）';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.DAY IS 'パーティション:日';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.HOUR IS 'パーティション:時';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.METADATA IS 'メタデータ';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.METRIC_ID IS 'メトリクスID';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.METRIC_NAME IS 'メトリクス名';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.METRIC_VALUE IS 'メトリクス値';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.MONTH IS 'パーティション:月';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.QUERY_ID IS 'クエリID';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.TIMESTAMP IS 'タイムスタンプ';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.USER_NAME IS 'ユーザー名';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.WAREHOUSE_NAME IS 'ウェアハウス名';
COMMENT ON COLUMN LOG.SNOWFLAKE_METRICS.YEAR IS 'パーティション:年';
