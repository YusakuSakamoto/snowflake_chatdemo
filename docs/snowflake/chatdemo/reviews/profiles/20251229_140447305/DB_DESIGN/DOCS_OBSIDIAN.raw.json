{"metrics":[{"as_of_at":"2025-12-30 05:05:52.825 -0800","column":"DOC_ID","metrics":{"distinct_count":9,"distinct_rate_non_null":1.000000000000000e+00,"max_len":32,"max_varchar":"a67ca3e6f4ddf28eb77abbdef581f05f","min_len":32,"min_varchar":"1877a8c1b366034fbd3197cc6e3bdac8","null_count":0,"null_rate":0.000000000000000e+00,"row_count":9,"top_values":[{"count":1,"value":"4d54f55c0a932b93a802eb7e05150b06"},{"count":1,"value":"9bfe8170b0df8cf12a2625672677dbb6"},{"count":1,"value":"818317c19b13140acb67cf01b6045900"},{"count":1,"value":"25e3b3df16467814137b0c148d309636"},{"count":1,"value":"a67ca3e6f4ddf28eb77abbdef581f05f"},{"count":1,"value":"22bc74f6d82967e5441b8a3b423ac441"},{"count":1,"value":"1877a8c1b366034fbd3197cc6e3bdac8"},{"count":1,"value":"31fbcd025c0f1ebef671a8c208937442"},{"count":1,"value":"24c0b45025f0800afc85a988c9dedfed"}]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:53.704 -0800","column":"CONTENT","metrics":{"distinct_count":14,"distinct_rate_non_null":1.000000000000000e+00,"max_len":6752,"max_varchar":"<%*\\n/**\\n * Schema template (Snowflake)\\n * - schema_id: SCH_YYYYMMDDHHmmss\\n * - filename: <physical>.md\\n * - moves file to master/schemas/\\n */\\nconst folder = \\"master/schemas\\";\\n\\nfunction safeFileName(name){\\n  return String(name ?? \\"SCHEMA\\")\\n    .trim()\\n    .replaceAll(\\"/\\", \\"_\\")\\n    .replaceAll(\\"\\\\\\\\\\", \\"_\\")\\n    .replaceAll(\\":\\", \\"_\\");\\n}\\n\\nconst schemaId = \\"SCH_\\" + tp.date.now(\\"YYYYMMDDHHmmss\\");\\nconst physicalRaw = await tp.system.prompt(\\"物理名（例: PUBLIC）\\");\\nconst physical = safeFileName(physicalRaw);\\nconst comment  = await tp.system.prompt(\\"comment（任意）\\") ?? \\"\\";\\n\\n// 配置先＋ファイル名を physical にする\\nawait tp.file.move(`${folder}/${physical}`);\\n-%>\\n---\\ntype: schema\\nschema_id: <%- schemaId %>\\nphysical: <%- physicalRaw %>\\ncomment: <%- comment %>\\n---\\n\\n# <%- physicalRaw %>\\n","min_len":88,"min_varchar":"\\n\\n```dataview\\nTABLE comment, physical\\nFROM \\"master/tables\\"\\nSORT schema_id, physical\\n```\\n","null_count":0,"null_rate":0.000000000000000e+00,"row_count":14,"top_values":[{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251227125402\\ntable_id: TBL_20251227124901\\nphysical: OBJECT_ID\\ndomain: VARCHAR\\npk: false\\nis_nullable: true\\ndefault:\\ncomment: 設計オブジェクトに紐づく論理 ID（schema_id / table_id / column_id / view_id 等）。frontmatter 由来。\\n---\\n\\n# OBJECT_ID\\n"},{"count":1,"value":"<%*\\n/**\\n * Schema template (Snowflake)\\n * - schema_id: SCH_YYYYMMDDHHmmss\\n * - filename: <physical>.md\\n * - moves file to master/schemas/\\n */\\nconst folder = \\"master/schemas\\";\\n\\nfunction safeFileName(name){\\n  return String(name ?? \\"SCHEMA\\")\\n    .trim()\\n    .replaceAll(\\"/\\", \\"_\\")\\n    .replaceAll(\\"\\\\\\\\\\", \\"_\\")\\n    .replaceAll(\\":\\", \\"_\\");\\n}\\n\\nconst schemaId = \\"SCH_\\" + tp.date.now(\\"YYYYMMDDHHmmss\\");\\nconst physicalRaw = await tp.system.prompt(\\"物理名（例: PUBLIC）\\");\\nconst physical = safeFileName(physicalRaw);\\nconst comment  = await tp.system.prompt(\\"comment（任意）\\") ?? \\"\\";\\n\\n// 配置先＋ファイル名を physical にする\\nawait tp.file.move(`${folder}/${physical}`);\\n-%>\\n---\\ntype: schema\\nschema_id: <%- schemaId %>\\nphysical: <%- physicalRaw %>\\ncomment: <%- comment %>\\n---\\n\\n# <%- physicalRaw %>\\n"},{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251229021259\\ntable_id: TBL_20251229020952\\nphysical: ENTITY_NAME\\ndomain: VARCHAR\\npk: false\\nis_nullable: false\\ndefault:\\ncomment: 正式名称（UI表示・確認用）\\n---\\n\\n# ENTITY_NAME\\n"},{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251229021602\\ntable_id: TBL_20251229020952\\nphysical: CREATED_AT\\ndomain: TIMESTAMP_NTZ\\npk: false\\nis_nullable: false\\ndefault: CURRENT_TIMESTAMP()\\ncomment:\\n---\\n\\n# CREATED_AT\\n"},{"count":1,"value":"\\n\\n```dataview\\nTABLE comment, physical\\nFROM \\"master/tables\\"\\nSORT schema_id, physical\\n```\\n"},{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251225144212\\ntable_id: TBL_20251225144134\\nphysical: ID\\ndomain: VARCHAR\\npk: false\\nis_nullable: true\\ndefault: \\ncomment: レコードID\\n---\\n\\n# ID\\n"},{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251226182047\\ntable_id: TBL_20251226180943\\nphysical: NOTE\\ndomain: VARCHAR\\npk: false\\nis_nullable: true\\ndefault:\\ncomment: 実行に関する補足情報やユーザメモ。異常終了時にはエラーコードおよびエラーメッセージが追記されることがある。\\n---\\n\\n# NOTE\\n"},{"count":1,"value":"# ビュー設計：V_INVOICE\\n\\n## 概要\\nAPP_PRODUCTION.V_INVOICE は、取込テーブル（案件明細）から **請求（invoice）を分析・参照しやすい単位に整形**して提供する VIEW である。\\n\\n取込側では請求番号が欠損している行や、同一請求が複数明細に分割されているケースがあり得る。  \\n本 VIEW はその前提を受け入れた上で、以下を実現する。\\n\\n- 請求の粒度を「請求×計上月」に固定する\\n- 請求番号が無い場合でも、請求を表すキーを作って集計可能にする\\n- 金額を請求単位で集計し、参照・分析の入口を提供する\\n\\n## 位置づけ（レイヤ）\\n- 入力：取込（Raw / Landing）層の案件明細テーブル（ANKEN_MEISAI）\\n- 出力：提供（Views / Normalized）層の請求 VIEW\\n- 下流利用：\\n  - セマンティックモデル（YAML）の INVOICES テーブル相当\\n  - オーダ（V_ORDER_MASTER）との JOIN 起点\\n  - 月次売上（請求金額）集計のベース\\n\\n本 VIEW は請求の正本テーブルではなく、デモ用途の「正規化提供層」として機能する。\\n\\n## 粒度（Grain）\\n本 VIEW の 1レコードは、以下の単位を表す。\\n\\n- 請求キー（invoice_key）\\n- 計上月（accounting_month）\\n\\n請求番号が存在する場合は請求番号が実質的な識別子になる。  \\n一方で、請求番号が欠損しているケースを許容するため、本 VIEW では「請求キー」を導入して粒度を安定させる。\\n\\n## 請求キー（invoice_key）の設計意図\\n取込データには、請求番号（invoice_number）が欠損している明細が存在しうる。  \\nその場合でも「請求という概念」を分析上扱えるよう、本 VIEW では請求キーを定義する。\\n\\n- 請求番号がある場合：請求番号をキーとして採用する\\n- 請求番号がない場合：オーダ番号を用いて仮キーを生成する  \\n  （例：NO_INVOICE_<order_number>）\\n\\nこの設計により、\\n- 請求番号が無い明細を WHERE 句で除外せずに済む\\n- 売上集計（請求金額）の欠落を避けられる\\n- 「請求番号の欠損」をデータ品質問題として可視化しつつ、分析は継続できる\\n\\n※ 仮キーは「請求の正本識別子」ではなく、「集計・参照のための暫定キー」である。\\n\\n## 集計の考え方（SUM / MAX / ANY_VALUE）\\n取込側では同一請求（キー）・同一計上月に複数明細が存在しうるため、本 VIEW は請求単位に集約する。\\n\\n- 金額は請求の合計値として SUM する（請求金額の集計済値を提供する）\\n- 売上渡しフラグ等の状態は、同一請求内で矛盾していても VIEW を破綻させないために集約する  \\n  （例：MAX による代表状態の選択）\\n- オーダ番号など請求に紐づく参照キーは、同一請求内で基本的に一致する前提で代表値として選択し得る\\n\\n本 VIEW はデータ品質の矛盾を解決する層ではなく、\\n「分析で扱える最小限の形にまとめる層」である。\\n\\n## フィルタ方針（重要）\\n本 VIEW は、請求番号が無い行を **除外しない**。  \\n請求番号欠損を理由にデータを落とすと、売上集計が欠落するためである。\\n\\nしたがって、\\n- 請求番号が無い明細は仮キー側に集約される\\n- 欠損の存在は結果（invoice_key の形）で可視化される\\n\\n## 計上月（accounting_month）の意味\\n本 VIEW の粒度は「請求×計上月」であり、計上月は請求集計の基準となる。\\n\\n- 取込層では計上月が文字列表現であることを許容する\\n- セマンティックモデル側では、計上月を DATE（当月1日）に変換して時系列分析に利用することがある  \\n  （VIEW 自体は「保持」と「集約」を主目的とする）\\n\\n## データ品質に関する前提\\n本 VIEW は、取込層のデータ品質を完全に保証するものではない。  \\nただし、参照・分析で最低限破綻しないよう、以下を前提とする。\\n\\n- 請求番号欠損は許容し、仮キーで集約する\\n- 同一請求内で属性が揺れている場合、集約結果が採用される（揺れは別途検知対象）\\n- 計上月が欠損または不正な場合、請求単位の集計結果に影響しうる（監査対象）\\n\\n## 運用上の注意\\n- 本 VIEW は売上（請求金額）集計の入口として利用し、取込テーブルを直接参照する運用を避ける\\n- 仮キー（NO_INVOICE_*）が発生する割合は、データ品質の重要指標になり得る\\n- 将来的に請求正本テーブルや請求番号管理が導入される場合、本 VIEW の仮キー設計は見直し対象となる\\n\\n## 関連\\n- スキーマ設計：[[design.APP_PRODUCTION]]\\n- 取込テーブル設計：[[design.ANKEN_MEISAI]]\\n- 関連 VIEW：[[design.V_ORDER_MASTER]] / [[design.V_PROJECT_MASTER]] / [[design.V_CUSTOMER_MASTER]]\\n- セマンティックモデル（INVOICES）：YAML 側の INVOICES 定義（別途管理）\\n\\n---\\n"},{"count":1,"value":"---\\ntype: view\\nview_id: VW_20251227014013\\nschema_id: SCH_20251226180633\\nphysical: DOCS_OBSIDIAN_V\\ncomment: Obsidian VaultのMarkdownを解析し、Cortex Search/Agent用の検索メタ情報を付与したVIEW\\n---\\n\\n# DOCS_OBSIDIAN_V\\n\\n## View Columns\\n> ここは VIEW の括弧内定義（列名＋列コメント）を書く（型は不要）\\n\\n| column_name   | comment                                                   |\\n| ------------- | --------------------------------------------------------- |\\n| DOC_ID        | Obsidianノートの一意ID（1ファイル=1レコード）                             |\\n| PATH          | Vault内のMarkdownファイルパス（.md付き）                              |\\n| FOLDER        | Vault内のフォルダパス（PATHの上位）                                    |\\n| CONTENT       | Markdown本文（全文）                                            |\\n| UPDATED_AT    | Snowflakeに取り込まれた時刻（最新判定用）                                 |\\n| SCOPE         | Vault上の大分類（master / design / views / templates / other）   |\\n| FILE_TYPE     | ノート種別（master_columns / profile_evidence / agent_review 等） |\\n| RUN_DATE      | EvidenceやReviewの対象日（YYYY-MM-DD）。パスまたはfrontmatterから抽出      |\\n| TARGET_SCHEMA | 対象スキーマ名（PATH規約から抽出）                                       |\\n| TARGET_TABLE  | 対象テーブル名（PATH規約から抽出）                                       |\\n| TARGET_COLUMN | 対象カラム名（master/columns のみ）                                 |\\n\\n## SQL\\n```sql\\nWITH base AS (\\n  SELECT\\n    DOC_ID,\\n    PATH,\\n    FOLDER,\\n    CONTENT,\\n    INGESTED_AT AS UPDATED_AT\\n  FROM DB_DESIGN.DOCS_OBSIDIAN\\n),\\nparsed AS (\\n  SELECT\\n    DOC_ID,\\n    PATH,\\n    FOLDER,\\n    CONTENT,\\n    UPDATED_AT,\\n\\n    /* 大分類 */\\n    CASE\\n      WHEN PATH LIKE 'master/%'     THEN 'master'\\n      WHEN PATH LIKE 'design/%'     THEN 'design'\\n      WHEN PATH LIKE 'views/%'      THEN 'views'\\n      WHEN PATH LIKE 'templates/%'  THEN 'templates'\\n      ELSE 'other'\\n    END AS SCOPE,\\n\\n    /* 詳細種別（検索・Agent制御用） */\\n    CASE\\n      WHEN PATH LIKE 'master/columns/%' THEN 'master_columns'\\n      WHEN PATH LIKE 'master/tables/%'  THEN 'master_tables'\\n      WHEN PATH LIKE 'master/schemas/%' THEN 'master_schemas'\\n      WHEN PATH LIKE 'master/views/%'   THEN 'master_views'\\n      WHEN PATH LIKE 'master/other/%'   THEN 'master_other'\\n      WHEN PATH LIKE 'design/reviews/profiles/%' THEN 'profile_evidence'\\n      WHEN PATH LIKE 'design/reviews/agent/%'    THEN 'agent_review'\\n      ELSE 'misc'\\n    END AS FILE_TYPE,\\n\\n    /* RUN_DATE：パス優先 → frontmatter fallback */\\n    COALESCE(\\n      /* profiles */\\n      IFF(PATH LIKE 'design/reviews/profiles/%',\\n          REGEXP_SUBSTR(\\n            PATH,\\n            'design/reviews/profiles/([0-9]{4}-[0-9]{2}-[0-9]{2})/',\\n            1, 1, 'e', 1\\n          ),\\n          NULL\\n      ),\\n\\n      /* agent */\\n      IFF(PATH LIKE 'design/reviews/agent/%',\\n          REGEXP_SUBSTR(\\n            PATH,\\n            'design/reviews/agent/([0-9]{4}-[0-9]{2}-[0-9]{2})/',\\n            1, 1, 'e', 1\\n          ),\\n          NULL\\n      ),\\n\\n      /* frontmatter: review_date */\\n      REGEXP_SUBSTR(\\n        CONTENT,\\n        '^review_date:\\\\\\\\s*([0-9]{4}-[0-9]{2}-[0-9]{2})\\\\\\\\s*$',\\n        1, 1, 'me', 1\\n      ),\\n\\n      /* frontmatter: generated_on */\\n      REGEXP_SUBSTR(\\n        CONTENT,\\n        '^generated_on:\\\\\\\\s*([0-9]{4}-[0-9]{2}-[0-9]{2})\\\\\\\\s*$',\\n        1, 1, 'me', 1\\n      )\\n    ) AS RUN_DATE,\\n\\n    /* TARGET_SCHEMA */\\n    IFF(PATH LIKE 'master/columns/%',\\n        REGEXP_SUBSTR(\\n          PATH,\\n          'master/columns/([^.]+)\\\\\\\\.',\\n          1, 1, 'e', 1\\n        ),\\n        COALESCE(\\n          IFF(PATH LIKE 'design/reviews/profiles/%',\\n              REGEXP_SUBSTR(\\n                PATH,\\n                'design/reviews/profiles/[0-9-]+/([^/]+)/',\\n                1, 1, 'e', 1\\n              ),\\n              NULL\\n          ),\\n          IFF(PATH LIKE 'design/reviews/agent/%',\\n              REGEXP_SUBSTR(\\n                PATH,\\n                'design/reviews/agent/[0-9-]+/([^/]+)/',\\n                1, 1, 'e', 1\\n              ),\\n              NULL\\n          )\\n        )\\n    ) AS TARGET_SCHEMA,\\n\\n    /* TARGET_TABLE */\\n    IFF(PATH LIKE 'master/columns/%',\\n        REGEXP_SUBSTR(\\n          PATH,\\n          'master/columns/[^.]+\\\\\\\\.([^.]+)\\\\\\\\.',\\n          1, 1, 'e', 1\\n        ),\\n        COALESCE(\\n          IFF(PATH LIKE 'design/reviews/profiles/%',\\n              REGEXP_SUBSTR(\\n                PATH,\\n                'design/reviews/profiles/[0-9-]+/[^/]+/([^/]+)\\\\\\\\.md$',\\n                1, 1, 'e', 1\\n              ),\\n              NULL\\n          ),\\n          IFF(PATH LIKE 'design/reviews/agent/%',\\n              REGEXP_SUBSTR(\\n                PATH,\\n                'design/reviews/agent/[0-9-]+/[^/]+/([^/]+)\\\\\\\\.review\\\\\\\\.md$',\\n                1, 1, 'e', 1\\n              ),\\n              NULL\\n          )\\n        )\\n    ) AS TARGET_TABLE,\\n\\n    /* TARGET_COLUMN（master/columns のみ） */\\n    IFF(PATH LIKE 'master/columns/%',\\n        REGEXP_SUBSTR(\\n          PATH,\\n          'master/columns/[^.]+\\\\\\\\.[^.]+\\\\\\\\.([^.]+)\\\\\\\\.md$',\\n          1, 1, 'e', 1\\n        ),\\n        NULL\\n    ) AS TARGET_COLUMN\\n\\n  FROM base\\n)\\nSELECT\\n  DOC_ID,\\n  PATH,\\n  FOLDER,\\n  CONTENT,\\n  UPDATED_AT,\\n  SCOPE,\\n  FILE_TYPE,\\n  RUN_DATE,\\n  TARGET_SCHEMA,\\n  TARGET_TABLE,\\n  TARGET_COLUMN\\nFROM parsed\\n```\\n"},{"count":1,"value":"\\n\\n```dataview\\nTABLE comment, physical, domain\\nFROM \\"master/columns\\"\\nSORT table_id, pk desc\\n```\\n\\n"},{"count":1,"value":"---\\ntype: column\\ncolumn_id: COL_20251226181139\\ntable_id: TBL_20251226180943\\nphysical: RUN_ID\\ndomain: VARCHAR\\npk: true\\nis_nullable: false\\ndefault:\\ncomment: プロファイル実行（run）を一意に識別するID。1回の PROFILE_TABLE 実行につき1つ発行される。原則としてUUID等によりアプリケーション側で一意生成され、同一RUN_IDでの再実行時は結果を上書きする。\\n---\\n\\n# RUN_ID\\n"},{"count":1,"value":"---\\ntype: other\\nschema_id: SCH_20251226180633\\nphysical: PROFILE_TABLE\\nobject_type: procedure\\ncomment:\\n---\\n\\n# SQL\\n```sql\\nCREATE OR REPLACE PROCEDURE DB_DESIGN.PROFILE_TABLE(\\n    P_TARGET_DB     STRING,\\n    P_TARGET_SCHEMA STRING,\\n    P_TARGET_TABLE  STRING,\\n    P_SAMPLE_PCT    FLOAT DEFAULT NULL,\\n    P_RUN_ID        STRING DEFAULT NULL,\\n    P_GIT_COMMIT    STRING DEFAULT NULL,\\n    P_NOTE          STRING DEFAULT NULL\\n)\\nRETURNS STRING\\nLANGUAGE SQL\\nEXECUTE AS OWNER\\nAS\\n$$\\nDECLARE\\n  V_RUN_ID    STRING;\\n  V_STARTED   TIMESTAMP_LTZ;\\n\\n  V_QDB   STRING;\\n  V_QSC   STRING;\\n  V_QTB   STRING;\\n  V_FULL  STRING;\\n\\n  V_COL_RS   RESULTSET;\\n  V_COL_NAME STRING;\\n\\n  V_QCOL    STRING;\\n  V_SQL     STRING;\\n  V_METRICS VARIANT;\\n  V_SQLC    STRING;\\nBEGIN\\n  /* ========== RUN 初期化 ========== */\\n  V_STARTED := CURRENT_TIMESTAMP();\\n  V_RUN_ID  := COALESCE(P_RUN_ID, 'RUN-' || UUID_STRING());\\n\\n  /* ========== RUN 登録（冪等） ========== */\\n  MERGE INTO DB_DESIGN.PROFILE_RUNS T\\n  USING (\\n    SELECT\\n      :V_RUN_ID        AS RUN_ID,\\n      :P_TARGET_DB     AS TARGET_DB,\\n      :P_TARGET_SCHEMA AS TARGET_SCHEMA,\\n      :P_TARGET_TABLE  AS TARGET_TABLE,\\n      :P_SAMPLE_PCT    AS SAMPLE_PCT,\\n      :V_STARTED       AS STARTED_AT,\\n      'RUNNING'        AS STATUS,\\n      CURRENT_WAREHOUSE() AS WAREHOUSE_NAME,\\n      CURRENT_ROLE()      AS ROLE_NAME,\\n      :P_GIT_COMMIT    AS GIT_COMMIT,\\n      :P_NOTE          AS NOTE\\n  ) S\\n  ON T.RUN_ID = S.RUN_ID\\n  WHEN MATCHED THEN\\n    UPDATE SET\\n      STARTED_AT     = S.STARTED_AT,\\n      FINISHED_AT    = NULL,\\n      STATUS         = 'RUNNING',\\n      SAMPLE_PCT     = S.SAMPLE_PCT,\\n      WAREHOUSE_NAME = S.WAREHOUSE_NAME,\\n      ROLE_NAME      = S.ROLE_NAME,\\n      GIT_COMMIT     = S.GIT_COMMIT,\\n      NOTE           = S.NOTE\\n  WHEN NOT MATCHED THEN\\n    INSERT (\\n      RUN_ID, TARGET_DB, TARGET_SCHEMA, TARGET_TABLE,\\n      SAMPLE_PCT, STARTED_AT, STATUS,\\n      WAREHOUSE_NAME, ROLE_NAME, GIT_COMMIT, NOTE\\n    )\\n    VALUES (\\n      S.RUN_ID, S.TARGET_DB, S.TARGET_SCHEMA, S.TARGET_TABLE,\\n      S.SAMPLE_PCT, S.STARTED_AT, S.STATUS,\\n      S.WAREHOUSE_NAME, S.ROLE_NAME, S.GIT_COMMIT, S.NOTE\\n    );\\n\\n  /* ========== 再実行対策：既存結果削除 ========== */\\n  DELETE FROM DB_DESIGN.PROFILE_RESULTS\\n   WHERE RUN_ID = :V_RUN_ID;\\n\\n  /* ========== 対象テーブル（フル修飾） ========== */\\n  V_QDB  := '\\"' || REPLACE(P_TARGET_DB, '\\"', '\\"\\"') || '\\"';\\n  V_QSC  := '\\"' || REPLACE(P_TARGET_SCHEMA, '\\"', '\\"\\"') || '\\"';\\n  V_QTB  := '\\"' || REPLACE(P_TARGET_TABLE, '\\"', '\\"\\"') || '\\"';\\n  V_FULL := V_QDB || '.' || V_QSC || '.' || V_QTB;\\n\\n  /* ========== 列一覧取得 ========== */\\n  V_SQLC := '\\n    SELECT COLUMN_NAME\\n    FROM ' || V_QDB || '.INFORMATION_SCHEMA.COLUMNS\\n    WHERE TABLE_SCHEMA = ?\\n      AND TABLE_NAME   = ?\\n    ORDER BY ORDINAL_POSITION\\n  ';\\n  V_COL_RS := (EXECUTE IMMEDIATE :V_SQLC USING (P_TARGET_SCHEMA, P_TARGET_TABLE));\\n\\n  /* ========== 列ごとのメトリクス算出 ========== */\\n  FOR REC IN V_COL_RS DO\\n    V_COL_NAME := REC.COLUMN_NAME;\\n    V_QCOL := '\\"' || REPLACE(V_COL_NAME, '\\"', '\\"\\"') || '\\"';\\n\\n    V_SQL := '\\nWITH SRC AS (\\n  SELECT * FROM ' || V_FULL ||\\n  CASE\\n    WHEN P_SAMPLE_PCT IS NULL THEN ''\\n    ELSE ' TABLESAMPLE BERNOULLI(' || P_SAMPLE_PCT || ')'\\n  END || '\\n),\\nAGG AS (\\n  SELECT\\n    COUNT(*) AS row_count,\\n    SUM(IFF(' || V_QCOL || ' IS NULL, 1, 0)) AS null_count,\\n    COUNT(DISTINCT ' || V_QCOL || ') AS distinct_count,\\n    MIN(TO_VARCHAR(' || V_QCOL || ')) AS min_varchar,\\n    MAX(TO_VARCHAR(' || V_QCOL || ')) AS max_varchar,\\n    MIN(LENGTH(TO_VARCHAR(' || V_QCOL || '))) AS min_len,\\n    MAX(LENGTH(TO_VARCHAR(' || V_QCOL || '))) AS max_len\\n  FROM SRC\\n),\\nTOP_VALUES AS (\\n  SELECT\\n    TO_VARCHAR(' || V_QCOL || ') AS v,\\n    COUNT(*) AS c\\n  FROM SRC\\n  WHERE ' || V_QCOL || ' IS NOT NULL\\n  GROUP BY 1\\n  ORDER BY c DESC\\n  LIMIT 20\\n)\\nSELECT OBJECT_CONSTRUCT(\\n  ''row_count'', row_count,\\n  ''null_count'', null_count,\\n  ''null_rate'', IFF(row_count=0, NULL, null_count::FLOAT/row_count),\\n  ''distinct_count'', distinct_count,\\n  ''distinct_rate_non_null'', IFF((row_count-null_count)=0, NULL, distinct_count::FLOAT/(row_count-null_count)),\\n  ''min_varchar'', min_varchar,\\n  ''max_varchar'', max_varchar,\\n  ''min_len'', min_len,\\n  ''max_len'', max_len,\\n  ''top_values'', (SELECT ARRAY_AGG(OBJECT_CONSTRUCT(''value'', v, ''count'', c)) FROM TOP_VALUES)\\n) AS METRICS\\nFROM AGG\\n';\\n\\n    EXECUTE IMMEDIATE :V_SQL;\\n\\n    SELECT METRICS\\n      INTO :V_METRICS\\n      FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()));\\n\\n    INSERT INTO DB_DESIGN.PROFILE_RESULTS\\n      (RUN_ID, TARGET_DB, TARGET_SCHEMA, TARGET_TABLE,\\n       TARGET_COLUMN, AS_OF_AT, METRICS)\\n    SELECT\\n      :V_RUN_ID, :P_TARGET_DB, :P_TARGET_SCHEMA, :P_TARGET_TABLE,\\n      :V_COL_NAME, CURRENT_TIMESTAMP(), :V_METRICS;\\n  END FOR;\\n\\n  /* ========== RUN 正常終了 ========== */\\n  UPDATE DB_DESIGN.PROFILE_RUNS\\n     SET FINISHED_AT = CURRENT_TIMESTAMP(),\\n         STATUS      = 'SUCCEEDED'\\n   WHERE RUN_ID = :V_RUN_ID;\\n\\n  RETURN V_RUN_ID;\\n\\nEXCEPTION\\n  WHEN OTHER THEN\\n    UPDATE DB_DESIGN.PROFILE_RUNS\\n       SET FINISHED_AT = CURRENT_TIMESTAMP(),\\n           STATUS      = 'FAILED',\\n           NOTE =\\n             COALESCE(:P_NOTE, '') ||\\n             IFF(:P_NOTE IS NULL, '', ' | ') ||\\n             'ERROR(' || :SQLCODE || '): ' || :SQLERRM\\n     WHERE RUN_ID = :V_RUN_ID;\\n    RAISE;\\nEND;\\n$$;\\n```\\n\\n"},{"count":1,"value":"---\\ntype: other\\nschema_id: SCH_20251226180633\\nphysical: INGEST_VAULT_MD\\nobject_type: procedure\\ncomment:\\n---\\n\\n# SQL\\n```sql\\nCREATE OR REPLACE PROCEDURE DB_DESIGN.INGEST_VAULT_MD(\\"STAGE_NAME\\" VARCHAR, \\"PATTERN\\" VARCHAR)\\nRETURNS VARIANT\\nLANGUAGE PYTHON\\nRUNTIME_VERSION = '3.11'\\nPACKAGES = ('snowflake-snowpark-python')\\nHANDLER = 'run'\\nEXECUTE AS OWNER\\nAS '\\nimport hashlib\\nfrom snowflake.snowpark.files import SnowflakeFile\\n\\nBUCKET = \\"135365622922-snowflake-dbdesign\\"\\n\\ndef _md5(s: str) -> str:\\n    return hashlib.md5(s.encode(\\"utf-8\\")).hexdigest()\\n\\ndef _to_relpath(name: str) -> str:\\n    \\"\\"\\"\\n    LIST結果のnameが\\n      - s3://<bucket>/path...\\n      - path...\\n    のどちらでも、ステージ相対パスを返す。\\n    \\"\\"\\"\\n    n = str(name).lstrip(\\"/\\")\\n    prefix = f\\"s3://{BUCKET}/\\"\\n    if n.startswith(prefix):\\n        return n[len(prefix):]\\n    # 念のため一般形（s3://bucket/...）も扱う\\n    if n.startswith(\\"s3://\\"):\\n        parts = n.split(\\"/\\", 3)\\n        # [''s3:'', '''', ''<bucket>'', ''<rest>'']\\n        return parts[3] if len(parts) >= 4 else \\"\\"\\n    return n\\n\\ndef run(session, stage_name, pattern):\\n    rows = session.sql(f\\"LIST {stage_name} PATTERN=''{pattern}''\\").collect()\\n\\n    processed = 0\\n    errors = 0\\n    samples = []\\n\\n    for r in rows:\\n        try:\\n            d = r.as_dict()\\n            full_name = d[\\"name\\"]\\n            last_modified = d.get(\\"last_modified\\", None)\\n\\n            relpath = _to_relpath(full_name)\\n            if not relpath:\\n                raise Exception(f\\"Could not derive relpath from name={full_name}\\")\\n\\n            # scoped url: 第2引数はステージ相対パス\\n            safe_rel = relpath.replace(\\"''\\", \\"''''\\")\\n            scoped_url = session.sql(\\n                f\\"SELECT BUILD_SCOPED_FILE_URL({stage_name}, ''{safe_rel}'') AS U\\"\\n            ).collect()[0][\\"U\\"]\\n\\n            with SnowflakeFile.open(scoped_url, \\"rb\\") as f:\\n                content = f.read().decode(\\"utf-8\\", errors=\\"replace\\")\\n\\n            folder = relpath.split(\\"/\\", 1)[0] if \\"/\\" in relpath else relpath\\n            doc_id = _md5(relpath)\\n\\n            session.sql(\\n                \\"\\"\\"\\nMERGE INTO DB_DESIGN.DOCS_OBSIDIAN t\\nUSING (\\n  SELECT\\n    ? AS DOC_ID,\\n    ? AS PATH,\\n    ? AS FOLDER,\\n    ? AS CONTENT,\\n    TRY_TO_TIMESTAMP_TZ(?)::TIMESTAMP_LTZ AS FILE_LAST_MODIFIED\\n) s\\nON t.DOC_ID = s.DOC_ID\\nWHEN MATCHED AND (\\n     t.FILE_LAST_MODIFIED IS NULL\\n  OR s.FILE_LAST_MODIFIED IS NULL\\n  OR s.FILE_LAST_MODIFIED > t.FILE_LAST_MODIFIED\\n)\\nTHEN UPDATE SET\\n  PATH = s.PATH,\\n  FOLDER = s.FOLDER,\\n  CONTENT = s.CONTENT,\\n  FILE_LAST_MODIFIED = s.FILE_LAST_MODIFIED,\\n  INGESTED_AT = CURRENT_TIMESTAMP()\\nWHEN NOT MATCHED THEN\\n  INSERT (DOC_ID, PATH, FOLDER, CONTENT, FILE_LAST_MODIFIED)\\n  VALUES (s.DOC_ID, s.PATH, s.FOLDER, s.CONTENT, s.FILE_LAST_MODIFIED)\\n                \\"\\"\\",\\n                params=[doc_id, relpath, folder, content, last_modified]\\n            ).collect()\\n\\n            processed += 1\\n\\n        except Exception as e:\\n            errors += 1\\n            if len(samples) < 5:\\n                samples.append({\\"error\\": str(e), \\"name\\": d.get(\\"name\\")})\\n\\n    return {\\"files_listed\\": len(rows), \\"processed\\": processed, \\"errors\\": errors, \\"samples\\": samples}\\n';\\n```\\n"},{"count":1,"value":"\\n```yaml\\nname: SV_SALES\\ndescription: らくらく案件データ（正規化VIEW群）を元にした売上・請求分析向けセマンティックモデル\\n\\ntables:\\n  - name: DEPARTMENTS\\n    description: 部署マスタ（年度別）\\n    base_table:\\n      database: GBPS253YS_DB\\n      schema: APP_PRODUCTION\\n      table: DEPARTMENT_MASTER\\n    primary_key:\\n      columns: [FISCAL_YEAR, DEPARTMENT_ID]\\n    dimensions:\\n      - name: DEPARTMENT_CODE\\n        expr: DEPARTMENT_CODE\\n        data_type: TEXT\\n        description: 部CD（部の配下をまとめるキー）。1桁の文字列。\\n        synonyms: [\\"部CD\\", \\"部コード\\", \\"部\\", \\"department_code\\"]\\n      - name: SECTION_CODE\\n        expr: SECTION_CODE\\n        data_type: TEXT\\n        description: 課CD。1桁の文字列。\\n        synonyms: [\\"課CD\\", \\"課コード\\", \\"課\\", \\"section_code\\"]\\n      - name: GROUP_CODE\\n        expr: GROUP_CODE\\n        data_type: TEXT\\n        description: グループCD。1桁の文字列。\\n        synonyms: [\\"グループCD\\", \\"グループコード\\", \\"グループ\\", \\"group_code\\"]\\n      - name: FISCAL_YEAR\\n        expr: FISCAL_YEAR\\n        data_type: TEXT\\n        description: 年度\\n      - name: DEPARTMENT_ID\\n        expr: DEPARTMENT_ID\\n        data_type: TEXT\\n        description: 部署ID\\n\\n  - name: CUSTOMERS\\n    description: 取引先マスタ（正規化VIEW）\\n    base_table:\\n      database: GBPS253YS_DB\\n      schema: APP_PRODUCTION\\n      table: V_CUSTOMER_MASTER\\n    primary_key:\\n      columns: [CUSTOMER_ID]\\n    dimensions:\\n      - name: CUSTOMER_ID\\n        expr: CUSTOMER_ID\\n        data_type: TEXT\\n        description: 取引先ID\\n        synonyms: [\\"顧客ID\\", \\"取引先コード\\"]\\n      - name: CUSTOMER_NAME\\n        expr: CUSTOMER_NAME\\n        data_type: TEXT\\n        description: 取引先名\\n        synonyms: [\\"顧客名\\", \\"取引先名\\"]\\n      - name: ACTIVE_FLAG\\n        expr: ACTIVE_FLAG\\n        data_type: TEXT\\n        description: 有効無効フラグ\\n\\n  - name: PROJECTS\\n    description: 案件マスタ（案件番号＋枝番＋年度）\\n    base_table:\\n      database: GBPS253YS_DB\\n      schema: APP_PRODUCTION\\n      table: V_PROJECT_MASTER\\n    primary_key:\\n      columns: [PROJECT_NUMBER, BRANCH_NUMBER, FISCAL_YEAR]\\n    dimensions:\\n      - name: PROJECT_NUMBER\\n        expr: PROJECT_NUMBER\\n        data_type: TEXT\\n        description: 案件番号\\n      - name: BRANCH_NUMBER\\n        expr: BRANCH_NUMBER\\n        data_type: TEXT\\n        description: 枝番\\n      - name: FISCAL_YEAR\\n        expr: FISCAL_YEAR\\n        data_type: TEXT\\n        description: 年度\\n      - name: PROJECT_NAME\\n        expr: PROJECT_NAME\\n        data_type: TEXT\\n        description: 案件名\\n        synonyms: [\\"案件\\"]\\n      - name: SUBJECT\\n        expr: SUBJECT\\n        data_type: TEXT\\n        description: 件名\\n      - name: SALES_CATEGORY\\n        expr: SALES_CATEGORY\\n        data_type: TEXT\\n        description: 売上区分\\n      - name: RANK\\n        expr: RANK\\n        data_type: TEXT\\n        description: 案件ランク\\n        synonyms: [\\"ランク\\", \\"確度\\", \\"ステータス\\", \\"確定ランク\\", \\"確定済\\"]\\n      - name: CUSTOMER_ID\\n        expr: CUSTOMER_ID\\n        data_type: TEXT\\n        description: 取引先ID\\n      - name: DEPARTMENT_ID\\n        expr: DEPARTMENT_ID\\n        data_type: TEXT\\n        description: 部署ID\\n      - name: WORK_START_DATE\\n        expr: WORK_START_DATE\\n        data_type: DATE\\n        description: 作業開始日\\n      - name: WORK_END_DATE\\n        expr: WORK_END_DATE\\n        data_type: DATE\\n        description: 作業終了日\\n      - name: IS_CONFIRMED\\n        expr: CASE WHEN RANK = '確定' THEN 'Y' ELSE 'N' END\\n        data_type: TEXT\\n        description: 確定ランク判定\\n        synonyms: [\\"確定\\", \\"確定済\\", \\"確定ランク\\"]\\n\\n  - name: ORDERS\\n    description: オーダマスタ（オーダ番号）\\n    base_table:\\n      database: GBPS253YS_DB\\n      schema: APP_PRODUCTION\\n      table: V_ORDER_MASTER\\n    primary_key:\\n      columns: [ORDER_NUMBER]\\n    dimensions:\\n      - name: ORDER_NUMBER\\n        expr: ORDER_NUMBER\\n        data_type: TEXT\\n        description: オーダ番号\\n        synonyms: [\\"受注番号\\", \\"オーダ\\"]\\n      - name: ORDER_NAME\\n        expr: ORDER_NAME\\n        data_type: TEXT\\n        description: オーダ名\\n      - name: CUSTOMER_ORDER_NUMBER\\n        expr: CUSTOMER_ORDER_NUMBER\\n        data_type: TEXT\\n        description: 顧客注文番号\\n        synonyms: [\\"PO番号\\"]\\n      - name: PROJECT_NUMBER\\n        expr: PROJECT_NUMBER\\n        data_type: TEXT\\n        description: 案件番号\\n      - name: BRANCH_NUMBER\\n        expr: BRANCH_NUMBER\\n        data_type: TEXT\\n        description: 枝番\\n      - name: FISCAL_YEAR\\n        expr: FISCAL_YEAR\\n        data_type: TEXT\\n        description: 年度\\n\\n  - name: INVOICES\\n    description: 請求（請求番号×計上月、金額は集計済）\\n    base_table:\\n      database: GBPS253YS_DB\\n      schema: APP_PRODUCTION\\n      table: V_INVOICE\\n    primary_key:\\n      columns: [INVOICE_KEY, ACCOUNTING_MONTH]\\n    dimensions:\\n      - name: INVOICE_KEY\\n        expr: INVOICE_KEY\\n        data_type: TEXT\\n        description: 請求キー（請求番号 or 仮キー）\\n      - name: ACCOUNTING_DATE\\n        expr: TO_DATE(ACCOUNTING_MONTH || '/01', 'YYYY/MM/DD')\\n        data_type: DATE\\n        description: 計上月（ACCOUNTING_MONTH を月初日の DATE に変換）\\n        synonyms: [\\"計上日\\", \\"計上月\\", \\"売上月\\", \\"月\\", \\"month\\"]\\n      - name: ACCOUNTING_MONTH\\n        expr: ACCOUNTING_MONTH\\n        data_type: TEXT\\n        description: 計上月（YYYY/MM 形式・表示用）\\n        synonyms: [\\"計上月文字列\\"]\\n      - name: ORDER_NUMBER\\n        expr: ORDER_NUMBER\\n        data_type: TEXT\\n        description: オーダ番号\\n      - name: SALES_DELIVERY_FLAG\\n        expr: SALES_DELIVERY_FLAG\\n        data_type: TEXT\\n        description: 売上渡しフラグ\\n    facts:\\n      - name: AMOUNT\\n        expr: AMOUNT\\n        data_type: NUMBER\\n        description: 請求金額（集計済）\\n    metrics:\\n      - name: TOTAL_SALES\\n        expr: SUM(AMOUNT)\\n        description: 売上合計（請求金額合計）\\n        synonyms: [\\"売上\\", \\"請求合計\\"]\\n      - name: INVOICE_COUNT\\n        expr: COUNT(DISTINCT CONCAT(INVOICE_NUMBER, '-', ACCOUNTING_MONTH))\\n        description: 請求件数（請求×計上月）\\n\\nrelationships:\\n  - name: PROJECTS_TO_CUSTOMERS\\n    left_table: PROJECTS\\n    right_table: CUSTOMERS\\n    join_type: left_outer\\n    relationship_type: many_to_one\\n    relationship_columns:\\n      - left_column: CUSTOMER_ID\\n        right_column: CUSTOMER_ID\\n\\n  - name: ORDERS_TO_PROJECTS\\n    left_table: ORDERS\\n    right_table: PROJECTS\\n    join_type: left_outer\\n    relationship_type: many_to_one\\n    relationship_columns:\\n      - left_column: PROJECT_NUMBER\\n        right_column: PROJECT_NUMBER\\n      - left_column: BRANCH_NUMBER\\n        right_column: BRANCH_NUMBER\\n      - left_column: FISCAL_YEAR\\n        right_column: FISCAL_YEAR\\n\\n  - name: INVOICES_TO_ORDERS\\n    left_table: INVOICES\\n    right_table: ORDERS\\n    join_type: left_outer\\n    relationship_type: many_to_one\\n    relationship_columns:\\n      - left_column: ORDER_NUMBER\\n        right_column: ORDER_NUMBER\\n        \\n  - name: PROJECTS_TO_DEPARTMENTS\\n    left_table: PROJECTS\\n    right_table: DEPARTMENTS\\n    join_type: left_outer\\n    relationship_type: many_to_one\\n    relationship_columns:\\n      - left_column: FISCAL_YEAR\\n        right_column: FISCAL_YEAR\\n      - left_column: DEPARTMENT_ID\\n        right_column: DEPARTMENT_ID\\n```\\n"}]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:54.575 -0800","column":"FILE_LAST_MODIFIED","metrics":{"distinct_count":0,"null_count":24,"null_rate":1.000000000000000e+00,"row_count":24,"top_values":[]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:55.447 -0800","column":"FOLDER","metrics":{"distinct_count":2,"distinct_rate_non_null":1.538461538461539e-01,"max_len":6,"max_varchar":"master","min_len":6,"min_varchar":"design","null_count":0,"null_rate":0.000000000000000e+00,"row_count":13,"top_values":[{"count":11,"value":"master"},{"count":2,"value":"design"}]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:56.327 -0800","column":"INGESTED_AT","metrics":{"distinct_count":21,"distinct_rate_non_null":1.000000000000000e+00,"max_len":29,"max_varchar":"2025-12-30 01:43:31.068 -0800","min_len":29,"min_varchar":"2025-12-30 01:41:36.499 -0800","null_count":0,"null_rate":0.000000000000000e+00,"row_count":21,"top_values":[{"count":1,"value":"2025-12-30 01:42:19.607 -0800"},{"count":1,"value":"2025-12-30 01:43:05.146 -0800"},{"count":1,"value":"2025-12-30 01:42:42.011 -0800"},{"count":1,"value":"2025-12-30 01:41:49.378 -0800"},{"count":1,"value":"2025-12-30 01:42:54.330 -0800"},{"count":1,"value":"2025-12-30 01:41:46.836 -0800"},{"count":1,"value":"2025-12-30 01:42:05.110 -0800"},{"count":1,"value":"2025-12-30 01:41:42.517 -0800"},{"count":1,"value":"2025-12-30 01:43:07.172 -0800"},{"count":1,"value":"2025-12-30 01:43:03.133 -0800"},{"count":1,"value":"2025-12-30 01:43:23.089 -0800"},{"count":1,"value":"2025-12-30 01:42:08.731 -0800"},{"count":1,"value":"2025-12-30 01:43:04.483 -0800"},{"count":1,"value":"2025-12-30 01:41:36.499 -0800"},{"count":1,"value":"2025-12-30 01:42:58.435 -0800"},{"count":1,"value":"2025-12-30 01:42:31.253 -0800"},{"count":1,"value":"2025-12-30 01:42:04.221 -0800"},{"count":1,"value":"2025-12-30 01:43:01.789 -0800"},{"count":1,"value":"2025-12-30 01:43:31.068 -0800"},{"count":1,"value":"2025-12-30 01:41:37.809 -0800"}]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:57.198 -0800","column":"OBJECT_ID","metrics":{"distinct_count":0,"null_count":22,"null_rate":1.000000000000000e+00,"row_count":22,"top_values":[]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:58.041 -0800","column":"OBJECT_TYPE","metrics":{"distinct_count":0,"null_count":22,"null_rate":1.000000000000000e+00,"row_count":22,"top_values":[]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"},{"as_of_at":"2025-12-30 05:05:58.909 -0800","column":"PATH","metrics":{"distinct_count":13,"distinct_rate_non_null":1.000000000000000e+00,"max_len":74,"max_varchar":"views/schemas.md","min_len":16,"min_varchar":"design/APP_PRODUCTION/design.V_INVOICE.md","null_count":0,"null_rate":0.000000000000000e+00,"row_count":13,"top_values":[{"count":1,"value":"design/APP_PRODUCTION/design.V_INVOICE.md"},{"count":1,"value":"master/columns/APP_PRODUCTION.DEPARTMENT_MASTER.DIVISION_CODE.md"},{"count":1,"value":"master/schemas/NAME_RESOLUTION.md"},{"count":1,"value":"design/DB_DESIGN/design.PROFILE_RUNS.md"},{"count":1,"value":"master/columns/APP_PRODUCTION.DIM_ENTITY_ALIAS_MANUAL.PRIORITY.md"},{"count":1,"value":"master/columns/DB_DESIGN.PROFILE_RUNS.NOTE.md"},{"count":1,"value":"master/columns/DB_DESIGN.PROFILE_RESULTS.TARGET_TABLE.md"},{"count":1,"value":"master/tables/APP_PRODUCTION.DEPARTMENT_MASTER.md"},{"count":1,"value":"master/columns/APP_PRODUCTION.DEPARTMENT_MASTER.GENERAL_DEPARTMENT_CODE.md"},{"count":1,"value":"views/schemas.md"},{"count":1,"value":"master/views/APP_PRODUCTION.V_PROJECT_FACT.md"},{"count":1,"value":"master/columns/APP_PRODUCTION.ANKEN_MEISAI.CUSTOMER_ORDER_NUMBER.md"},{"count":1,"value":"master/other/DB_DESIGN.OBSIDIAN_VAULT_STAGE.md"}]},"run_id":"RUN-7f998fad-03d4-4749-a26e-ebebb353a476"}],"run_date":"20251229_140447305","target_db":"GBPS253YS_DB","target_schema":"DB_DESIGN","target_table":"DOCS_OBSIDIAN"}
