---
type: agent_review
review_date: 2026-01-02
target: DB_DESIGN
---

# DB_DESIGN 設計レビュー

## 0. メタ情報
- 対象: DB_DESIGN
- レビュー日: 2026-01-02
- 対象ノート候補（PATH一覧）:
  - design/design.DB_DESIGN.md
  - design/DB_DESIGN/design.PROFILE_RUNS.md
  - design/DB_DESIGN/design.PROFILE_RESULTS.md
  - master/tables/DB_DESIGN.PROFILE_RUNS.md
  - master/tables/DB_DESIGN.PROFILE_RESULTS.md
  - master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
  - master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
  - master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
  - master/columns/DB_DESIGN.PROFILE_RESULTS.METRICS.md

## 1. サマリ（3行）
- DB_DESIGN スキーマは設計レビュー基盤として十分に設計思想が明確化されており、基本的な設計品質は高い。
- PROFILE_RUNS と PROFILE_RESULTS の外部キー関係が明示的に定義されていない点とメタデータ設計において将来拡張性に課題がある。
- 設計ドキュメントは詳細に記述されており、設計意図・業務的意味・更新ポリシーが明確に定義されている。

## 2. Findings（重要度別）
### High
#### High-1: 外部キー関係の明示的定義不足
- 指摘: PROFILE_RUNS.RUN_ID と PROFILE_RESULTS.RUN_ID の論理的な外部キー関係がSnowflake DDL上で明示的に定義されていない
- 影響: データ整合性の検証が実行時まで遅延し、不整合データの混入リスクが存在する
- 提案: Snowflake の外部キー制約（情報的制約）を明示的に定義し、論理関係を可視化する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "データ整合性は、テーブル制約ではなく、プロシージャ内の処理ロジック（状態遷移、再実行制御、エラーハンドリング）によって担保する。"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "[[DB_DESIGN.PROFILE_RESULTS.RUN_ID]] → [[DB_DESIGN.PROFILE_RUNS.RUN_ID]] [[design.PROFILE_RESULTS]] は、必ず既存の run に紐づく結果としてのみ存在する前提とする。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
    変更内容: FK制約コメント追加、参照テーブル情報の明記

#### High-2: STATUS列の値域制御不足
- 指摘: STATUS列において許可値（'RUNNING', 'SUCCEEDED', 'FAILED'）がCHECK制約等で強制されていない
- 影響: 不正な状態値の挿入により監視・運用判断に誤りが生じる可能性がある
- 提案: STATUS列にCHECK制約またはドメイン定義を追加し、許可値を明示的に制限する
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    抜粋: "許可値は以下の通り：RUNNING : 実行中SUCCEEDED : 正常終了FAILED : 異常終了状態遷移は原則として RUNNING → SUCCEEDED | FAILED のみとする。"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "SnowflakeではPKやCHECK制約によるデータ排除が限定的であるため、データ整合性はDDL制約ではなく、プロシージャ内のロジックと運用ルールで担保する。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    変更内容: CHECK制約またはドメイン制約の検討コメント追加

#### High-3: PROFILE_RESULTS複合主キーの不完全性
- 指摘: 複合主キー（RUN_ID, TARGET_COLUMN）にTARGET_DB/SCHEMA/TABLEが含まれておらず、異なるテーブルの同名カラムで衝突リスクがある
- 影響: 論理的に異なるテーブルのカラム結果が同一runで重複・上書きされる可能性がある
- 提案: 複合主キーをRUN_ID + TARGET_DB + TARGET_SCHEMA + TARGET_TABLE + TARGET_COLUMNの5列構成に変更する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "主キーは以下の複合キーとする。[[DB_DESIGN.PROFILE_RESULTS.RUN_ID]] [[DB_DESIGN.PROFILE_RESULTS.TARGET_COLUMN]]"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "1回の run において、同一カラムの結果は高々 1行である。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
    変更内容: 複合主キー構成の再検討と修正

### Med
#### Med-1: METRICS列の構造化不足
- 指摘: VARIANT型のMETRICS列において期待される構造やスキーマが明示されていない
- 影響: メトリクス結果の解釈一貫性が保たれず、分析効率が低下する可能性がある
- 提案: METRICSの標準的なJSONスキーマまたは期待フィールド一覧を設計文書に明記する
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.METRICS.md
    抜粋: "カラム単位のプロファイル計測結果を格納するVARIANT。NULL率、件数、distinct数、最小値・最大値などを柔軟に保持する。"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "メトリクス構造は固定せず、将来拡張を許容する。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    変更内容: METRICSの標準構造例とフィールド仕様の追記

#### Med-2: ドメイン統一性の課題
- 指摘: 同一概念（RUN_ID）が異なるテーブルで同じVARCHAR型を使用しているが、具体的なサイズ制約が明示されていない
- 影響: UUID等の実装変更時にカラム定義の整合性確保が困難になる
- 提案: RUN_IDのドメイン仕様（文字数制限、フォーマット）を明確に定義し、共通ドメインとして管理する
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
    抜粋: "プロファイル実行（run）を一意に識別するID。1回の PROFILE_TABLE 実行につき1つ発行される。原則としてUUID等によりアプリケーション側で一意生成され"
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
    抜粋: "プロファイル実行（run）を識別するID。PROFILE_RUNS.RUN_ID と対応し、どの実行に紐づく結果かを示す。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/design.DB_DESIGN.md
    変更内容: 共通ドメイン定義の追加、RUN_ID仕様の明確化

### Low
#### Low-1: 命名規則の明文化不足
- 指摘: テーブル名・カラム名の命名規則がスキーマ設計書に明示的に記述されていない
- 影響: 将来のテーブル追加時に命名の一貫性が保たれない可能性がある
- 提案: 命名規則（アンダースコア記法、省略形ルール等）を設計書に明記する
- Evidence:
  - PATH: design/design.DB_DESIGN.md
    抜粋: "命名・制約ポリシー「DDLで縛らない理由」などの判断"
  - PATH: master/tables/DB_DESIGN.PROFILE_RUNS.md
    抜粋: "PROFILE_RUNS"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/design.DB_DESIGN.md
    変更内容: 命名規則セクションの追加

#### Low-2: デフォルト値設計の一貫性
- 指摘: NULL許容列において、デフォルト値の設定方針が明確でない
- 影響: データ挿入時の動作が予測しにくく、運用負荷が増加する可能性がある
- 提案: NULL許容列のデフォルト値設定基準を整理し、設計書に記載する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "NULL許容：実行状況や起動経路により取得できない、または意味を持たない可能性がある属性"
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
    抜粋: "default:"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/design.DB_DESIGN.md
    変更内容: デフォルト値設定ポリシーの明文化

## 3. 【仮説】の検証（該当がある場合のみ）
該当なし

## 4. 追加で集めたい情報（不足がある場合のみ）
該当なし（レビュー対象テーブル数制限により、より詳細な情報は既存の2テーブルで十分）

## 5. 改善提案（次アクション）
- 実施内容: 外部キー制約の明示的定義とSTATUS値域制御の実装
  期待効果: データ整合性の向上と運用時の不正値混入防止
  優先度: High
  変更対象PATH（案）: master/columns/, design/design.DB_DESIGN.md
- 実施内容: PROFILE_RESULTS複合主キーの見直しとMETRICS構造の標準化
  期待効果: データ重複防止と分析効率の向上
  優先度: Med
  変更対象PATH（案）: design/DB_DESIGN/design.PROFILE_RESULTS.md