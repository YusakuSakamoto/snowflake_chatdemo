---
type: agent_review
review_date: 2026-01-02
target: DB_DESIGN
---

# DB_DESIGN 設計レビュー

## 0. メタ情報
- 対象: DB_DESIGN
- レビュー日: 2026-01-02
- 対象ノート候補（PATH一覧）:
  - design/design.DB_DESIGN.md
  - design/DB_DESIGN/design.PROFILE_RUNS.md
  - design/DB_DESIGN/design.PROFILE_RESULTS.md
  - master/tables/DB_DESIGN.PROFILE_RUNS.md
  - master/tables/DB_DESIGN.PROFILE_RESULTS.md

## 1. サマリ（3行）
- DB_DESIGNスキーマは設計メタ管理基盤として明確な位置づけを持つが、FK制約の欠如による関連整合性リスクが存在
- 命名規則は一貫しているが、STATUSカラムのCHECK制約未定義により無効な状態値混入リスクがある
- 設計ドキュメントは非常に充実しており、各テーブルの設計思想・業務意味・制約理由が明確に記述されている

## 2. Findings（重要度別）

### Critical
#### Critical-1: 外部キー制約の未定義によるデータ整合性リスク
- 指摘: PROFILE_RESULTS.RUN_ID に対応する外部キー制約が未定義のため、存在しないRUN_IDでの結果登録や参照整合性不整合が発生する可能性
- 影響: **本番障害リスクレベル: 高**
- 提案: PROFILE_RESULTS.RUN_ID に対する外部キー制約を追加し、PROFILE_RUNS.RUN_IDとの参照整合性を保証する
- DDL例（該当する場合）:
  ```sql
  ALTER TABLE DB_DESIGN.PROFILE_RESULTS
  ADD CONSTRAINT FK_PROFILE_RESULTS_RUN_ID
  FOREIGN KEY (RUN_ID) REFERENCES DB_DESIGN.PROFILE_RUNS(RUN_ID)
  ```
- 移行手順（既存データがある場合）:
  1. 既存データの整合性検証クエリ実行
  2. 不整合データのクリーンアップ
  3. 外部キー制約追加
  4. 整合性検証
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "[[design.PROFILE_RESULTS]] は、必ず既存の run に紐づく結果としてのみ存在する前提とする。"
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
    抜粋: "プロファイル実行（run）を識別するID。PROFILE_RUNS.RUN_ID と対応し、どの実行に紐づく結果かを示す。"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "各runは RUN_ID により識別され、結果テーブル（[[design.PROFILE_RESULTS]]）と論理的に関連付けられる。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/tables/DB_DESIGN.PROFILE_RESULTS.md
    変更内容: |
      FK制約の追加をテーブルコメントに記載
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 即時

### High
#### High-1: STATUS値の制約不足による無効状態混入リスク
- 指摘: PROFILE_RUNS.STATUSカラムでCHECK制約が未定義のため、設計書で定義された'RUNNING','SUCCEEDED','FAILED'以外の無効値が混入する可能性
- 影響: 状態遷移ロジックの破綻、監視システムの誤動作リスク
- 提案: STATUSカラムにCHECK制約を追加し、許可値を明示的に制限する
- DDL例（該当する場合）:
  ```sql
  ALTER TABLE DB_DESIGN.PROFILE_RUNS
  ADD CONSTRAINT CHK_PROFILE_RUNS_STATUS
  CHECK (STATUS IN ('RUNNING', 'SUCCEEDED', 'FAILED'))
  ```
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    抜粋: "プロファイル実行の状態。許可値は以下の通り：RUNNING : 実行中SUCCEEDED : 正常終了FAILED : 異常終了状態遷移は原則として RUNNING → SUCCEEDED | FAILED のみとする。"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "STATUS='RUNNING' の間は FINISHED_AT はNULLであることを前提とする。STATUS in ('SUCCEEDED','FAILED') の場合は FINISHED_AT が必ず設定される。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    変更内容: CHECK制約の追加をコメントに記載
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 低
  - 推奨実施時期: 今週

#### High-2: 状態遷移整合性の制約不足
- 指摘: FINISHED_ATとSTATUSの整合性（RUNNING時はNULL、完了時は非NULL）がテーブル制約で保証されていない
- 影響: 論理的不整合データの混入（実行中だが終了時刻あり、完了しているが終了時刻なし等）
- 提案: 複合制約またはトリガーによる状態整合性チェックの実装
- DDL例（該当する場合）:
  ```sql
  ALTER TABLE DB_DESIGN.PROFILE_RUNS
  ADD CONSTRAINT CHK_STATUS_FINISHED_CONSISTENCY
  CHECK (
    (STATUS = 'RUNNING' AND FINISHED_AT IS NULL) OR
    (STATUS IN ('SUCCEEDED', 'FAILED') AND FINISHED_AT IS NOT NULL)
  )
  ```
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "STATUS='RUNNING' の間は FINISHED_AT はNULLであることを前提とする。STATUS in ('SUCCEEDED','FAILED') の場合は FINISHED_AT が必ず設定される。"
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.FINISHED_AT.md
    抜粋: "プロファイル実行終了時刻。実行中（STATUS='RUNNING'）はNULL、完了時（SUCCEEDED / FAILED）に設定される。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/tables/DB_DESIGN.PROFILE_RUNS.md
    変更内容: 状態整合性制約の記載追加
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今週

### Med
#### Med-1: VARCHAR長の未指定によるストレージ非効率
- 指摘: RUN_ID、STATUSなどのVARCHAR列で長さが未指定のため、デフォルトの最大長（16MB）が適用されストレージ効率が悪化
- 影響: ストレージコスト増加、クエリパフォーマンス劣化
- 提案: 各VARCHAR列に適切な長さ制限を設定（RUN_ID: 36文字、STATUS: 10文字等）
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
    抜粋: "domain: VARCHAR"
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    抜粋: "domain: VARCHAR"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
    変更内容: domain: VARCHAR(36) への変更

#### Med-2: 複合主キー設計の妥当性検証不足
- 指摘: PROFILE_RESULTSで複合主キー（RUN_ID, TARGET_COLUMN）を採用しているが、TARGET_COLUMNの一意性保証や長さ制限が不明確
- 影響: 主キー重複エラーやパフォーマンス問題の潜在リスク
- 提案: TARGET_COLUMN列の制約明確化（長さ制限、NULL制約等）とキー設計の妥当性検証
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "主キーは以下の複合キーとする。[[DB_DESIGN.PROFILE_RESULTS.RUN_ID]] [[DB_DESIGN.PROFILE_RESULTS.TARGET_COLUMN]]"
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.RUN_ID.md
    抜粋: "pk: true"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    変更内容: 複合主キー設計の詳細化

### Low
#### Low-1: コメント記述の統一性向上
- 指摘: 一部カラムでコメントが簡潔すぎる（METRICS: "カラム単位のプロファイル計測結果を格納する..."）
- 影響: 保守性・可読性の軽微な低下
- 提案: 全カラムのコメント記述レベルを統一し、業務的意味を明確化
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.METRICS.md
    抜粋: "comment: カラム単位のプロファイル計測結果を格納するVARIANT。NULL率、件数、distinct数、最小値・最大値などを柔軟に保持する。"
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.RUN_ID.md
    抜粋: "comment: プロファイル実行（run）を一意に識別するID。1回の PROFILE_TABLE 実行につき1つ発行される。原則としてUUID等によりアプリケーション側で一意生成され、同一RUN_IDでの再実行時は結果を上書きする。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.METRICS.md
    変更内容: より詳細なコメント記述

## 3. 【仮説】の検証（該当がある場合のみ）
該当なし

## 4. 追加で集めたい情報（不足がある場合のみ）
- 追加調査: 実際のDDL確認（制約の現状把握）
- 追加ツール実行案: 残りテーブルの設計レビュー実行

## 5. 改善提案（次アクション）
- 実施内容: Critical指摘の外部キー制約追加とHigh指摘のCHECK制約追加
  期待効果: データ整合性保証とシステム安定性向上
  優先度: Critical
  変更対象PATH（案）: master/tables/配下の制約定義追加
  影響範囲: 中
  実装難易度: 中
  推奨実施時期: 即時