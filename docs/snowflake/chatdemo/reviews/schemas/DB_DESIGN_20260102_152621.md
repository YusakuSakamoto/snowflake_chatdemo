---
type: agent_review
review_date: 2026-01-02
target: DB_DESIGN
---

# DB_DESIGN 設計レビュー

## 0. メタ情報
- 対象: DB_DESIGN
- レビュー日: 2026-01-02
- 対象ノート候補（PATH一覧）:
  - design/design.DB_DESIGN.md
  - design/DB_DESIGN/design.PROFILE_RUNS.md
  - design/DB_DESIGN/design.PROFILE_RESULTS.md
  - master/tables/DB_DESIGN.PROFILE_RUNS.md
  - master/tables/DB_DESIGN.PROFILE_RESULTS.md

## 1. サマリ（3行）
- DB_DESIGNスキーマは設計メタ管理用の基盤として明確な思想を持ち、Obsidian VaultとSnowflakeの連携設計が適切に文書化されている
- PROFILE_RUNSとPROFILE_RESULTSの2テーブル構成でプロファイル実行管理が体系化されているが、FK制約の明示的定義とCHECK制約が不足している
- 設計書は詳細だが、STATUS列の許可値制御やMETRICS構造の標準化など運用品質担保の仕組みに改善余地がある

## 2. Findings（重要度別）

### Critical
#### Critical-1: FK制約未定義によるデータ整合性リスク
- 指摘: PROFILE_RESULTS.RUN_IDがPROFILE_RUNS.RUN_IDを参照する外部キー制約が未定義
- 影響: **本番障害リスクレベル: 高** - 孤立した結果データの混入、run削除時の不整合が発生し、プロファイル結果の信頼性が損なわれる
- 提案: FK制約を明示的に定義してデータ整合性を担保する
- DDL例（該当する場合）:
  ```
  ALTER TABLE DB_DESIGN.PROFILE_RESULTS 
  ADD CONSTRAINT FK_PROFILE_RESULTS_RUN_ID 
  FOREIGN KEY (RUN_ID) REFERENCES DB_DESIGN.PROFILE_RUNS(RUN_ID);
  ```
- 移行手順（既存データがある場合）:
  1. バックアップ作成
  2. 孤立データの確認・クリーンアップ
  3. FK制約追加
  4. 検証
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "関係性 [[DB_DESIGN.PROFILE_RUNS]]（1） → [[DB_DESIGN.PROFILE_RESULTS]]（N）"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "[[design.PROFILE_RESULTS]] は、必ず既存の run に紐づく結果としてのみ存在する前提とする"
  - PATH: design/design.DB_DESIGN.md
    抜粋: "SnowflakeではPKやCHECK制約によるデータ排除が限定的であるため、データ整合性はDDL制約ではなく、プロシージャ内のロジックと運用ルールで担保する"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/tables/DB_DESIGN.PROFILE_RESULTS.md
    変更内容: |
      FK制約定義の追加:
      ```
      FOREIGN KEY (RUN_ID) REFERENCES DB_DESIGN.PROFILE_RUNS(RUN_ID)
      ```
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 低
  - 推奨実施時期: 即時

#### Critical-2: 主キー定義の不明確性
- 指摘: PROFILE_RESULTSの複合主キー（RUN_ID + TARGET_COLUMN）がmaster定義に明示されていない
- 影響: **本番障害リスクレベル: 高** - 同一run内での重複データ挿入、データ整合性破綻のリスク
- 提案: 複合主キー制約を明示的に定義する
- DDL例（該当する場合）:
  ```
  ALTER TABLE DB_DESIGN.PROFILE_RESULTS 
  ADD CONSTRAINT PK_PROFILE_RESULTS 
  PRIMARY KEY (RUN_ID, TARGET_COLUMN);
  ```
- 移行手順（既存データがある場合）:
  1. バックアップ作成
  2. 重複データの確認・統合
  3. PK制約追加
  4. 検証
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "主キーは以下の複合キーとする。[[DB_DESIGN.PROFILE_RESULTS.RUN_ID]] [[DB_DESIGN.PROFILE_RESULTS.TARGET_COLUMN]]"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "1回の run において、同一カラムの結果は高々 1行である"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/tables/DB_DESIGN.PROFILE_RESULTS.md
    変更内容: |
      複合主キー制約の追加:
      ```
      PRIMARY KEY (RUN_ID, TARGET_COLUMN)
      ```
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 即時

### High
#### High-1: STATUS列の値制御不足
- 指摘: PROFILE_RUNS.STATUS列の許可値（RUNNING/SUCCEEDED/FAILED）がCHECK制約で制御されていない
- 影響: 不正な状態値の混入により、監視・運用処理が誤動作する可能性
- 提案: CHECK制約を追加して許可値を明示的に制御する
- DDL例（該当する場合）:
  ```
  ALTER TABLE DB_DESIGN.PROFILE_RUNS 
  ADD CONSTRAINT CHK_STATUS 
  CHECK (STATUS IN ('RUNNING', 'SUCCEEDED', 'FAILED'));
  ```
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    抜粋: "プロファイル実行の状態。許可値は以下の通り：RUNNING : 実行中SUCCEEDED : 正常終了FAILED : 異常終了"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "状態遷移は原則として RUNNING → SUCCEEDED | FAILED のみとする"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/DB_DESIGN.PROFILE_RUNS.STATUS.md
    変更内容: |
      CHECK制約の追加:
      ```
      CHECK (STATUS IN ('RUNNING', 'SUCCEEDED', 'FAILED'))
      ```
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低
  - 推奨実施時期: 今週

#### High-2: NULL制御の一貫性不足
- 指摘: 設計書でNULL許容の理由が明記されているが、DDL定義との対応関係が不明確
- 影響: 運用時のNULL値の扱いで混乱が生じ、データ品質が低下する可能性
- 提案: 各列のNULL許可設定を設計意図と整合させ、DDL定義を明確化する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "NULL許容：実行状況や起動経路により取得できない、または意味を持たない可能性がある属性 FINISHED_AT：実行中（STATUS='RUNNING'）はNULL、完了時に設定される"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "NULL許容列については、NULLであることの意味をカラムコメントに明記する"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/各NULL許容列.md
    変更内容: |
      各列の is_nullable 設定と comment の整合性確認・修正
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今週

### Med
#### Med-1: VARIANT型構造の標準化不足
- 指摘: PROFILE_RESULTS.METRICS列がVARIANT型で柔軟性を重視しているが、構造定義が曖昧
- 影響: 結果の解釈・比較・集計処理において一貫性が保たれない可能性
- 提案: 最小限の標準構造（必須フィールド）を定義し、拡張性を保持する
- Evidence:
  - PATH: master/columns/DB_DESIGN.PROFILE_RESULTS.METRICS.md
    抜粋: "カラム単位のプロファイル計測結果を格納するVARIANT。NULL率、件数、distinct数、最小値・最大値などを柔軟に保持する"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "メトリクス構造は固定せず、将来拡張を許容する"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    変更内容: METRICS構造の標準フォーマット例を追加

#### Med-2: クラスタリングキー設計の未検討
- 指摘: 検索頻度の高い軸（TARGET_*、STARTED_AT、STATUS）に対するクラスタリングキー設計が未検討
- 影響: 大量データ化時の検索性能低下
- 提案: 想定検索パターンに基づくクラスタリングキー設計を検討する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "実運用で参照頻度が高い検索軸（例：TARGET_* + STARTED_AT、STATUS）を意識し、必要に応じてクラスタリング等を検討する"
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "想定検索軸（TARGET_*、STARTED_AT、STATUS）に基づくクラスタリング検討"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    変更内容: クラスタリングキー設計方針の具体化

### Low
#### Low-1: ドメイン統一性の確認不足
- 指摘: TARGET_DB/TARGET_SCHEMA/TARGET_TABLE列が複数テーブルで重複定義されているが、ドメイン統一性の確認が不十分
- 影響: 将来的なデータ型不整合やJOIN処理での問題
- 提案: 共通ドメイン定義を明確化し、統一性を担保する
- Evidence:
  - PATH: design/DB_DESIGN/design.PROFILE_RUNS.md
    抜粋: "TARGET_DB / TARGET_SCHEMA / TARGET_TABLE"
  - PATH: design/DB_DESIGN/design.PROFILE_RESULTS.md
    抜粋: "[[DB_DESIGN.PROFILE_RESULTS.TARGET_DB]], [[DB_DESIGN.PROFILE_RESULTS.TARGET_SCHEMA]], [[DB_DESIGN.PROFILE_RESULTS.TARGET_TABLE]]"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/design.DB_DESIGN.md
    変更内容: 共通ドメイン定義の追加

## 3. 改善提案（次アクション）
- 実施内容: FK制約とPK制約の明示的定義、CHECK制約によるSTATUS値制御
  期待効果: データ整合性の確保、運用品質の向上、障害リスクの軽減
  優先度: Critical
  変更対象PATH（案）: master/tables/配下の各テーブル定義
  影響範囲: 中
  実装難易度: 低-中
  推奨実施時期: 即時