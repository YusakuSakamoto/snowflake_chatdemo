---
type: agent_review
review_date: 2026-01-03
target: DB_DESIGN
---

# DB_DESIGN 設計レビュー

## 0. メタ情報
- 対象: DB_DESIGN
- レビュー日: 2026-01-03
- 対象ノート候補（PATH一覧）:
  - README_DB_DESIGN.md
  - design/DB_DESIGN/design.DOCS_OBSIDIAN.md
  - design/DB_DESIGN/design.EXPORT_PROFILE_EVIDENCE_MD_VFINAL.md
  - design/DB_DESIGN/design.EXT_PROFILE_RESULTS.md
  - design/DB_DESIGN/design.EXT_PROFILE_RUNS.md
  - design/DB_DESIGN/design.GET_DOCS_BY_PATHS_AGENT.md
  - design/DB_DESIGN/design.INGEST_VAULT_MD.md
  - design/DB_DESIGN/design.LIST_SCHEMA_RELATED_DOC_PATHS_AGENT.md
  - design/DB_DESIGN/design.LIST_TABLE_RELATED_DOC_PATHS_AGENT.md
  - design/DB_DESIGN/design.OBSIDIAN_SCHEMA_DB_DESIGN_REVIEW_AGENT.md
  - design/DB_DESIGN/design.OBSIDIAN_VAULT_STAGE.md
  - design/DB_DESIGN/design.PROFILE_RUNS.md
  - design/design.DB_DESIGN.md

## 1. サマリ（3行）
- DB_DESIGNスキーマは、Obsidian VaultのMarkdownファイル管理とプロファイル実行履歴を担う設計基盤スキーマであり、SSOT（Single Source of Truth）原則に基づく設計思想が確立されている。
- 外部テーブル（EXT_PROFILE_*）とプロシージャ群（Agent関連）が適切に設計され、Cortex Agentとの連携フローが整備されているが、一部のオブジェクトでmaster定義との整合性確認が必要である。
- 設計思想・運用ルール・レビュー基準が体系的にドキュメント化されており、再現性・自動化耐性を重視した基盤設計として評価できる。

## 2. Findings（重要度別）

### High
#### High-1: 外部テーブルのmaster定義未確認
- 指摘: design配下には EXT_PROFILE_RESULTS と EXT_PROFILE_RUNS の詳細設計が存在するが、対応するmaster定義（master/externaltables/）の存在が確認できない
- 影響: DDL生成・自動処理・レビューの一貫性が担保されない。外部テーブルの物理定義とメタデータが不整合となり運用障害のリスクがある
- 提案: master/externaltables/DB_DESIGN.EXT_PROFILE_RESULTS.md および master/externaltables/DB_DESIGN.EXT_PROFILE_RUNS.md のmaster定義を作成する
- Evidence:
  - PATH: design/DB_DESIGN/design.EXT_PROFILE_RESULTS.md
    抜粋: "- マスター定義：[[DB_DESIGN.EXT_PROFILE_RESULTS]]（master/externaltables/）"
  - PATH: design/DB_DESIGN/design.EXT_PROFILE_RUNS.md
    抜粋: "- マスター定義：[[DB_DESIGN.EXT_PROFILE_RUNS]]（master/externaltables/）"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/externaltables/DB_DESIGN.EXT_PROFILE_RESULTS.md
    変更内容: |
      新規作成: 外部テーブル定義のYAML frontmatterとS3パス・パーティション設計を含む
  - 変更対象PATH: master/externaltables/DB_DESIGN.EXT_PROFILE_RUNS.md
    変更内容: |
      新規作成: 外部テーブル定義のYAML frontmatterとS3パス・パーティション設計を含む
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今週

#### High-2: プロシージャのmaster定義不整合
- 指摘: design配下にプロシージャ設計（INGEST_VAULT_MD、各Agent系）が多数存在するが、master/procedures/ 配下の対応定義が確認できない
- 影響: DDL生成時にプロシージャが抜け落ち、Vault正本とSnowflake実装の乖離が発生する。自動化処理での参照エラーが生じるリスク
- 提案: 各プロシージャのmaster定義（YAML frontmatter付きの正式定義）を master/procedures/ 配下に作成する
- Evidence:
  - PATH: design/DB_DESIGN/design.INGEST_VAULT_MD.md
    抜粋: "[[DB_DESIGN.INGEST_VAULT_MD]] は、S3ステージに同期されたObsidian VaultのMarkdownファイルを読み込み、[[DB_DESIGN.DOCS_OBSIDIAN]] テーブルに取り込むための専用プロシージャである"
  - PATH: design/DB_DESIGN/design.GET_DOCS_BY_PATHS_AGENT.md
    抜粋: "GET_DOCS_BY_PATHS_AGENTは、Obsidian Vault内のドキュメントを指定されたPATHリスト（JSON配列）から一括取得するストアドプロシージャである"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/procedures/DB_DESIGN.INGEST_VAULT_MD.md
    変更内容: |
      新規作成: procedure_id、パラメータ定義、戻り値定義を含むYAML frontmatter
  - 変更対象PATH: master/procedures/DB_DESIGN.GET_DOCS_BY_PATHS_AGENT.md
    変更内容: |
      新規作成: procedure_id、パラメータ定義、戻り値定義を含むYAML frontmatter
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今週

#### High-3: stage・ファイルフォーマットのmaster定義欠落
- 指摘: OBSIDIAN_VAULT_STAGEやFF_JSON_LINESなどの参照があるが、対応するmaster定義（master/other/）が確認できない
- 影響: DDL生成時にstage・ファイルフォーマットが抜け落ち、外部テーブル・プロシージャが動作不能となる運用障害リスク
- 提案: master/other/ 配下にstage・ファイルフォーマットのmaster定義を作成する
- Evidence:
  - PATH: design/DB_DESIGN/design.OBSIDIAN_VAULT_STAGE.md
    抜粋: "[[DB_DESIGN.OBSIDIAN_VAULT_STAGE]]は、DB_DESIGNスキーマ内に定義された外部ステージであり"
  - PATH: design/DB_DESIGN/design.EXT_PROFILE_RESULTS.md
    抜粋: "- ファイルフォーマット：FF_JSON_LINES"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/other/DB_DESIGN.OBSIDIAN_VAULT_STAGE.md
    変更内容: |
      新規作成: stage_id、URL、STORAGE_INTEGRATIONを含むYAML frontmatter
  - 変更対象PATH: master/other/DB_DESIGN.FF_JSON_LINES.md
    変更内容: |
      新規作成: fileformat_id、TYPE、各種オプションを含むYAML frontmatter
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今週

### Med
#### Med-1: プロファイル結果の二重管理設計の運用リスク
- 指摘: 内部テーブル（PROFILE_RESULTS）と外部テーブル（EXT_PROFILE_RESULTS）の使い分け方針が明記されているが、実際の同期・アーカイブ機構の詳細が不明
- 影響: 運用時にデータの不整合や重複取り込みが発生し、プロファイル結果の信頼性が低下する可能性
- 提案: 内部テーブル→外部テーブルの定期アーカイブ手順と、重複排除・整合性確認の運用手順を明文化
- Evidence:
  - PATH: design/DB_DESIGN/design.EXT_PROFILE_RESULTS.md
    抜粋: "初期段階では内部テーブル（[[design.PROFILE_RESULTS]]）にデータを蓄積し、定期的に外部テーブル（[[design.EXT_PROFILE_RESULTS]]）へアーカイブする運用を推奨する"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.EXT_PROFILE_RESULTS.md
    変更内容: |
      ## アーカイブ運用手順
      - 内部テーブル保持期間: 直近3ヶ月
      - 外部テーブルアーカイブ周期: 月次
      - 重複排除・整合性確認手順の詳細化
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低
  - 推奨実施時期: 今月

#### Med-2: Agent系プロシージャの権限・セキュリティ設計不明
- 指摘: Cortex Agent用プロシージャ群の実行権限・セキュリティ境界・アクセス制御の設計が明記されていない
- 影響: 不適切な権限設定によりセキュリティホールが生じる、または必要な権限不足で動作しない可能性
- 提案: 各Agentプロシージャの権限要件（EXECUTE AS、必要ROLE、アクセス可能スキーマ）を明文化
- Evidence:
  - PATH: design/DB_DESIGN/design.GET_DOCS_BY_PATHS_AGENT.md
    抜粋: "本プロシージャは、[[design.OBSIDIAN_SCHEMA_DB_DESIGN_REVIEW_AGENT]]をはじめとする各種Cortex Agentからgeneric toolとして呼び出され"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/DB_DESIGN/design.GET_DOCS_BY_PATHS_AGENT.md
    変更内容: |
      ## セキュリティ設計
      - 実行権限: EXECUTE AS CALLER/DEFINER
      - 必要ROLE: DB_DESIGN_READER
      - アクセス可能オブジェクト範囲の明示
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今月

## 3. 追加で集めたい情報
- 追加調査: master/tables/, master/views/, master/columns/ 配下の定義ファイル存在確認（DOCS_OBSIDIAN等の主要テーブルのmaster定義）
- 追加ツール実行案: list_table_related_doc_paths で DOCS_OBSIDIAN テーブルの関連定義（カラム含む）を取得し、master定義の網羅性を確認

## 4. 改善提案（次アクション）
- 実施内容: master定義の網羅的整備（externaltables, procedures, other配下）とdesign定義との整合性確保
  期待効果: DDL生成・自動処理の安定性向上、Vault正本としての完全性確保
  優先度: High
  変更対象PATH（案): master/externaltables/, master/procedures/, master/other/配下の新規作成
  影響範囲: 中
  実装難易度: 中
  推奨実施時期: 今週
