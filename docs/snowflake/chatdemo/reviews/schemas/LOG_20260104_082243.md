---
type: agent_review
review_date: 2026-01-03
target: LOG
---

# LOG 設計レビュー

## 0. メタ情報
- 対象: LOG
- レビュー日: 2026-01-03
- 対象ノート候補（PATH一覧）:
  - README_DB_DESIGN.md
  - design/LOG/design.AZFUNCTIONS_LOGS.md
  - design/LOG/design.AZSWA_LOGS.md
  - design/LOG/design.CORTEX_CONVERSATIONS.md
  - design/LOG/design.SNOWFLAKE_METRICS.md
  - design/design.DB_DESIGN.md
  - design/design.LOG.md

## 1. サマリ（3行）
- LOG スキーマの設計意図（design/）は非常に詳細で体系的に整備されているが、master 定義（DDL生成対象の正本）が完全に不在
- 外部テーブル4つ（AZFUNCTIONS_LOGS, AZSWA_LOGS, CORTEX_CONVERSATIONS, SNOWFLAKE_METRICS）の実装定義がなく、設計から実装への橋渡しが断絶
- Vault の SSOT 原則に反する状態であり、自動化・DDL生成・レビューの継続性に重大なリスク

## 2. Findings（重要度別）

### Critical
#### Critical-1: master定義の完全不在によるSSoT違反
- 指摘: LOG スキーマの全オブジェクト（AZFUNCTIONS_LOGS, AZSWA_LOGS, CORTEX_CONVERSATIONS, SNOWFLAKE_METRICS）について master 配下の定義ファイルが存在しない
- 影響: DDL生成不可能、実装と設計の整合性検証不可能、自動化プロセスの完全停止リスク
- 提案: 各外部テーブルの master 定義を緊急作成し、design との整合を確保する
- Evidence:
  - PATH: design/design.LOG.md
    抜粋: "各ログテーブルの設計判断"で4テーブルに言及するも master 定義への参照なし
  - PATH: README_DB_DESIGN.md  
    抜粋: "定義は必ず master を編集する" "design / reviews / views に定義を書かない"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/externaltables/LOG.AZFUNCTIONS_LOGS.md
    変更内容: |
      外部テーブル定義作成（type: externaltable, schema_id: SCH_20260102000001, 他）
  - 変更対象PATH: master/externaltables/LOG.AZSWA_LOGS.md, LOG.CORTEX_CONVERSATIONS.md, LOG.SNOWFLAKE_METRICS.md
    変更内容: |
      同様に外部テーブル定義を作成
- 実装メタ情報:
  - 影響範囲: 大
  - 実装難易度: 中
  - 推奨実施時期: 即時

#### Critical-2: schema定義の不在
- 指摘: LOG スキーマ自体の master 定義（master/schemas/LOG.md）が存在しない
- 影響: スキーマレベルでの管理・権限・DDL生成が不可能
- 提案: master/schemas/LOG.md を作成し、schema_id: SCH_20260102000001 として正規化する
- Evidence:
  - PATH: design/design.LOG.md
    抜粋: "schema_id:: SCH_20260102000001" で ID は定義済み
  - PATH: README_DB_DESIGN.md
    抜粋: "schema: master/schemas/<SCHEMA>.md"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/schemas/LOG.md
    変更内容: |
      type: schema, schema_id: SCH_20260102000001, logical: ログ統合基盤, physical: LOG
- 実装メタ情報:
  - 影響範囲: 大
  - 実装難易度: 低
  - 推奨実施時期: 即時

### High
#### High-1: 外部テーブルのカラム定義不在
- 指摘: design では詳細なカラム設計が記述されているが、対応する master/columns 定義が完全に不在
- 影響: カラムレベルでの制約・型・nullabilityの管理不可能、横断チェック機能停止
- 提案: design で言及される全カラムについて master/columns 定義を作成する
- Evidence:
  - PATH: design/LOG/design.AZFUNCTIONS_LOGS.md
    抜粋: "log_id (VARCHAR)" "function_name (VARCHAR)" "level (VARCHAR)" など詳細カラム定義
  - PATH: design/LOG/design.AZSWA_LOGS.md  
    抜粋: "log_id（主キー相当）" "request_id（相関 ID）" など主要カラム言及
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/LOG.AZFUNCTIONS_LOGS.*.md (複数ファイル)
    変更内容: |
      各カラムの定義（column_id, table_id, domain, is_nullable等）
- 実装メタ情報:
  - 影響範囲: 大
  - 実装難易度: 高
  - 推奨実施時期: 今週

### Med
#### Med-1: パーティション設計の実装詳細不足
- 指摘: design で "YEAR, MONTH, DAY, HOUR のパーティション" と記述されているが、具体的な PARTITION BY 句の定義が不明確
- 影響: パーティションプルーニング効果の検証困難、パフォーマンス最適化の根拠不足
- 提案: master 定義でパーティション列を明示し、検証クエリ例を併記する
- Evidence:
  - PATH: design/design.LOG.md
    抜粋: "YEAR / MONTH / DAY / HOUR のパーティションにより、時系列クエリで不要スキャンを削減"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/externaltables/LOG.*.md
    変更内容: |
      パーティション列の明示的定義追加
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今月

### Low  
#### Low-1: design間での表記揺れ
- 指摘: パーティション列の記述で "YEAR, MONTH, DAY, HOUR" と "year, month, day, hour" の大文字小文字が混在
- 影響: 仕様理解の曖昧性、実装時の判断ミス誘発可能性
- 提案: README の命名規則に従い統一表記にする
- Evidence:
  - PATH: README_DB_DESIGN.md
    抜粋: "パーティションカラム | 小文字英単語（Hive互換） | year, month, day, hour"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: design/design.LOG.md 他
    変更内容: パーティション列を小文字表記で統一
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低  
  - 推奨実施時期: 今月

## 3. 追加で集めたい情報
- 追加調査: 実際に master 定義が作成された場合の columns 詳細定義の取得
- 追加ツール実行案: master 定義作成後に list_table_related_doc_paths での columns 一覧取得

## 4. 改善提案（次アクション）
- 実施内容: LOG スキーマの master 定義完全整備（schema + 4つの外部テーブル + 全カラム定義）
  期待効果: SSOT 原則の回復、DDL生成可能化、自動化プロセス正常化
  優先度: Critical
  変更対象PATH（案）: master/schemas/LOG.md, master/externaltables/LOG.*.md, master/columns/LOG.*.*.md
  影響範囲: 大
  実装難易度: 中
  推奨実施時期: 即時
