
---
type: agent_review
review_date: 2026-01-03
target: LOG
---

# LOG 設計レビュー

## 0. メタ情報
- 対象: LOG
- レビュー日: 2026-01-03
- 対象ノート候補（PATH一覧）:
  - README_DB_DESIGN.md
  - design/design.DB_DESIGN.md
  - design/design.LOG.md
  - design/LOG/design.AZSWA_LOGS.md
  - master/externaltables/LOG.AZSWA_LOGS.md
  - master/columns/LOG.AZSWA_LOGS.CLIENT_IP.md
  - master/columns/LOG.AZSWA_LOGS.LOG_ID.md
  - master/columns/LOG.AZSWA_LOGS.STATUS.md
  - master/columns/LOG.AZSWA_LOGS.STATUS_CODE.md
  - master/columns/LOG.AZSWA_LOGS.METADATA.md
  - master/columns/LOG.AZSWA_LOGS.YEAR.md

## 1. サマリ（3行）
- LOG スキーマは外部テーブル中心のログ統合基盤として適切に設計されているが、STATUS/STATUS_CODE の型不整合とドメイン設計に改善が必要
- AZSWA_LOGS テーブルの設計は外部テーブルの制約を理解した運用前提の設計となっており、パーティション構成も適切
- METADATA カラムの VARIANT 型使用は適切だが、濫用防止ガイドラインが明示されており運用面も考慮されている

## 2. Findings（重要度別）

### High
#### High-1: STATUS カラムの型とドメイン定義に不整合
- 指摘: STATUS カラムが VARCHAR 型だが、設計書では有限の値（RUNNING/SUCCEEDED/FAILED）のみを想定しており、型とドメインの整合性が取れていない
- 影響: クエリパフォーマンス劣化、予期しない値の混入リスク、分析時の品質問題
- 提案: domain 設計を見直し、STATUS_ENUM など明確な値域制約を持つドメインに変更するか、運用での値域チェックを強化する
- Evidence:
  - PATH: design/LOG/design.AZSWA_LOGS.md
    抜粋: "STATUS（VARCHAR, nullable）- 意味: アプリケーション／業務ロジックの状態・想定値：RUNNING・SUCCEEDED・FAILED"
  - PATH: master/columns/LOG.AZSWA_LOGS.STATUS.md
    抜粋: "domain: VARCHAR"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/LOG.AZSWA_LOGS.STATUS.md
    変更内容: |
      domain: STATUS_ENUM または VARCHAR(20) + 値域制約の明示
- 実装メタ情報:
  - 影響範囲: 中
  - 実装難易度: 中
  - 推奨実施時期: 今月

### Med
#### Med-1: STATUS_CODE の精度設計が過大
- 指摘: STATUS_CODE が NUMBER(5,0) だが、HTTP ステータスコードは 3桁（100-599）のため精度が過大設定
- 影響: ストレージ効率の微小な劣化、意図しない値の許容リスク
- 提案: NUMBER(3,0) に変更し、HTTP標準に厳密に準拠する
- Evidence:
  - PATH: master/columns/LOG.AZSWA_LOGS.STATUS_CODE.md
    抜粋: "domain: NUMBER(5,0)・comment: HTTP標準に準拠した精度指定。200, 404, 500等のステータス値を格納。"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/LOG.AZSWA_LOGS.STATUS_CODE.md
    変更内容: domain: NUMBER(3,0)
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低
  - 推奨実施時期: 今月

#### Med-2: METADATA カラムの構造例が comment に混在
- 指摘: METADATA カラムの comment 欄に JSON 構造例が含まれており、定義と例示が混在している
- 影響: comment の可読性低下、構造変更時のメンテナンス負荷
- 提案: 構造例は設計ドキュメントに集約し、comment は簡潔な用途説明のみに統一する
- Evidence:
  - PATH: master/columns/LOG.AZSWA_LOGS.METADATA.md
    抜粋: "comment: 追加コンテキスト情報（例：referrer, ab_test_flag, experiment_id, custom_tags）。利用ガイドライン: 主要分析軸は固定カラムで持ち、METADATAは可変項目の吸収用。濫用を防ぐため、構造例・制限事項は設計ドキュメントに準拠。構造例: {\"referrer\": \"https://...\", \"ab_test_flag\": \"A\", \"experiment_id\": \"exp123\", \"custom_tags\": [\"tag1\", \"tag2\"]}"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/columns/LOG.AZSWA_LOGS.METADATA.md
    変更内容: comment: 追加コンテキスト情報。設計ドキュメント準拠で利用すること。
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低
  - 推奨実施時期: 今月

### Low
#### Low-1: 外部テーブル定義でのfile_format値が詳細不足
- 指摘: master/externaltables/LOG.AZSWA_LOGS.md で file_format: JSON のみ記載で、JSON Lines仕様が反映されていない
- 影響: DDL生成時の設定不足の可能性
- 提案: file_format_name または file_format 詳細設定を明示する
- Evidence:
  - PATH: master/externaltables/LOG.AZSWA_LOGS.md
    抜粋: "file_format: JSON"
- Vault差分案（AIは編集しない）:
  - 変更対象PATH: master/externaltables/LOG.AZSWA_LOGS.md
    変更内容: file_format_name: FF_JSON_LINES
- 実装メタ情報:
  - 影響範囲: 小
  - 実装難易度: 低
  - 推奨実施時期: Q1

## 5. 改善提案（次アクション）
- 実施内容: STATUS カラムのドメイン設計見直し・STATUS_CODE の精度適正化・METADATA の comment 整理
  期待効果: データ品質向上、運用安定性確保、保守性向上
  優先度: High / Med
  変更対象PATH（案）: master/columns/LOG.AZSWA_LOGS.STATUS.md, master/columns/LOG.AZSWA_LOGS.STATUS_CODE.md, master/columns/LOG.AZSWA_LOGS.METADATA.md
  影響範囲: 中
  実装難易度: 中
  推奨実施時期: 今月
